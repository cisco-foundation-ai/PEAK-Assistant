<!-- MCP Server Status Component -->
<div id="mcp-status-container" class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0">üîå MCP Server Status</h6>
        <div class="btn-group btn-group-sm" role="group">
            <button class="btn btn-outline-primary btn-sm" onclick="refreshMCPStatus()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
            <button class="btn btn-outline-secondary btn-sm" onclick="showMCPDetails()">
                <i class="fas fa-info-circle"></i> Details
            </button>
        </div>
    </div>
    <div class="card-body">
        <div id="mcp-servers-grid" class="row">
            <!-- MCP servers will be loaded here -->
            <div class="col-12 text-center">
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="sr-only">Loading MCP servers...</span>
                </div>
                <span class="ml-2 text-muted">Loading MCP server status...</span>
            </div>
        </div>
        
        <!-- Authentication prompt area -->
        <div id="auth-prompt-area" class="mt-3" style="display: none;">
            <div class="alert alert-info">
                <h6><i class="fas fa-shield-alt"></i> Enhanced Features Available</h6>
                <p class="mb-2">Some advanced research capabilities require your authentication:</p>
                <div id="auth-server-list"></div>
                <div class="mt-2">
                    <button class="btn btn-primary btn-sm" onclick="authenticateAllServers()">
                        <i class="fas fa-key"></i> Authenticate All
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="hideAuthPrompt()">
                        Continue Without Advanced Features
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MCP Server Details Modal -->
<div class="modal fade" id="mcpDetailsModal" tabindex="-1" role="dialog" aria-labelledby="mcpDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mcpDetailsModalLabel">MCP Server Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="mcp-details-content">
                    <!-- Detailed server information will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
// MCP Status Management
let mcpServers = {};

async function refreshMCPStatus() {
    try {
        const response = await fetch('/oauth/status');
        if (!response.ok) throw new Error('Failed to load MCP status');
        
        const data = await response.json();
        mcpServers = data.servers;
        renderMCPStatus();
        checkAuthenticationNeeds();
    } catch (error) {
        console.error('Error refreshing MCP status:', error);
        showMCPError('Failed to load MCP server status');
    }
}

function renderMCPStatus() {
    const grid = document.getElementById('mcp-servers-grid');
    grid.innerHTML = '';
    
    if (Object.keys(mcpServers).length === 0) {
        grid.innerHTML = '<div class="col-12 text-center text-muted">No MCP servers configured</div>';
        return;
    }
    
    for (const [serverName, serverInfo] of Object.entries(mcpServers)) {
        const serverCard = createServerStatusCard(serverName, serverInfo);
        grid.appendChild(serverCard);
    }
}

function createServerStatusCard(serverName, serverInfo) {
    const col = document.createElement('div');
    col.className = 'col-md-6 col-lg-4 mb-2';
    
    const statusIcon = getStatusIcon(serverInfo);
    const statusColor = getStatusColor(serverInfo);
    const actionButton = getActionButton(serverName, serverInfo);
    
    col.innerHTML = `
        <div class="card border-${statusColor}" style="min-height: 120px;">
            <div class="card-body p-2">
                <div class="d-flex justify-content-between align-items-start mb-1">
                    <h6 class="card-title mb-1 text-truncate" title="${serverInfo.description || serverName}">
                        ${statusIcon} ${serverName}
                    </h6>
                    <span class="badge badge-${statusColor} badge-sm">${serverInfo.status}</span>
                </div>
                <p class="card-text small text-muted mb-2" style="font-size: 0.8rem;">
                    ${serverInfo.description || 'MCP Server'}
                </p>
                <div class="text-center">
                    ${actionButton}
                </div>
            </div>
        </div>
    `;
    
    return col;
}

function getStatusIcon(serverInfo) {
    switch (serverInfo.status) {
        case 'authenticated': return 'üü¢';
        case 'available': return 'üîµ';
        case 'needs_auth': return 'üîê';
        case 'needs_config': return 'üî¥';
        case 'configured': return 'üü°';
        default: return '‚ö™';
    }
}

function getStatusColor(serverInfo) {
    switch (serverInfo.status) {
        case 'authenticated': return 'success';
        case 'available': return 'info';
        case 'needs_auth': return 'warning';
        case 'needs_config': return 'danger';
        case 'configured': return 'secondary';
        default: return 'light';
    }
}

function getActionButton(serverName, serverInfo) {
    if (serverInfo.status === 'needs_auth') {
        return `<button class="btn btn-warning btn-sm" onclick="authenticateServer('${serverName}')">
                    <i class="fas fa-key"></i> Authenticate
                </button>`;
    } else if (serverInfo.status === 'authenticated' && serverInfo.requires_user_auth) {
        return `<button class="btn btn-outline-secondary btn-sm" onclick="disconnectServer('${serverName}')">
                    <i class="fas fa-sign-out-alt"></i> Disconnect
                </button>`;
    } else if (serverInfo.status === 'needs_config') {
        return `<button class="btn btn-outline-danger btn-sm" disabled>
                    <i class="fas fa-exclamation-triangle"></i> Config Needed
                </button>`;
    } else {
        return `<button class="btn btn-success btn-sm" disabled>
                    <i class="fas fa-check"></i> Ready
                </button>`;
    }
}

async function checkAuthenticationNeeds() {
    try {
        const response = await fetch('/oauth/servers/needing-auth');
        if (!response.ok) return;
        
        const data = await response.json();
        if (data.count > 0) {
            showAuthPrompt(data.servers_needing_auth);
        } else {
            hideAuthPrompt();
        }
    } catch (error) {
        console.error('Error checking authentication needs:', error);
    }
}

function showAuthPrompt(serversNeedingAuth) {
    const authArea = document.getElementById('auth-prompt-area');
    const serverList = document.getElementById('auth-server-list');
    
    let listHTML = '<ul class="list-unstyled mb-0">';
    serversNeedingAuth.forEach(server => {
        listHTML += `
            <li class="mb-1">
                <strong>${server.name}</strong>: ${server.description}
                <button class="btn btn-sm btn-outline-primary ml-2" onclick="window.location.href='${server.auth_url}'">
                    Connect
                </button>
            </li>
        `;
    });
    listHTML += '</ul>';
    
    serverList.innerHTML = listHTML;
    authArea.style.display = 'block';
}

function hideAuthPrompt() {
    document.getElementById('auth-prompt-area').style.display = 'none';
}

async function authenticateServer(serverName) {
    window.location.href = `/oauth/authenticate/${serverName}`;
}

async function authenticateAllServers() {
    try {
        const response = await fetch('/oauth/servers/needing-auth');
        if (!response.ok) throw new Error('Failed to get servers needing auth');
        
        const data = await response.json();
        if (data.servers_needing_auth.length > 0) {
            // Authenticate first server, others will be prompted after callback
            const firstServer = data.servers_needing_auth[0];
            window.location.href = firstServer.auth_url;
        }
    } catch (error) {
        console.error('Error initiating bulk authentication:', error);
        alert('Failed to initiate authentication process');
    }
}

async function disconnectServer(serverName) {
    if (confirm(`Disconnect from ${serverName}? You'll need to re-authenticate to use advanced features.`)) {
        window.location.href = `/oauth/disconnect/${serverName}`;
    }
}

function showMCPDetails() {
    const content = document.getElementById('mcp-details-content');
    let detailsHTML = '<div class="table-responsive"><table class="table table-sm">';
    detailsHTML += '<thead><tr><th>Server</th><th>Auth Type</th><th>Status</th><th>Description</th></tr></thead><tbody>';
    
    for (const [serverName, serverInfo] of Object.entries(mcpServers)) {
        const statusBadge = `<span class="badge badge-${getStatusColor(serverInfo)}">${serverInfo.status}</span>`;
        detailsHTML += `
            <tr>
                <td><strong>${serverName}</strong></td>
                <td>${serverInfo.auth_type}</td>
                <td>${statusBadge}</td>
                <td class="small">${serverInfo.description || 'N/A'}</td>
            </tr>
        `;
    }
    
    detailsHTML += '</tbody></table></div>';
    content.innerHTML = detailsHTML;
    $('#mcpDetailsModal').modal('show');
}

function showMCPError(message) {
    const grid = document.getElementById('mcp-servers-grid');
    grid.innerHTML = `
        <div class="col-12">
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> ${message}
                <button class="btn btn-sm btn-outline-danger ml-2" onclick="refreshMCPStatus()">
                    Retry
                </button>
            </div>
        </div>
    `;
}

// Initialize MCP status when page loads
document.addEventListener('DOMContentLoaded', function() {
    refreshMCPStatus();
    
    // Refresh status periodically (every 30 seconds)
    setInterval(refreshMCPStatus, 30000);
});
</script>
