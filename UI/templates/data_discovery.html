{% extends "base.html" %}

{% block title %}Data Discovery - PEAK Assistant{% endblock %}

{% set prev_phase_url = "/able-table" %}
{% set prev_phase_name = "ABLE Table" %}
{% set next_phase_url = "/hunt-planning" %}
{% set next_phase_name = "Generate Hunt Plan" %}

{% block nav %}{{ super() }}{% endblock %}

{% block content %}
<style>
    /* Custom styles for Data Discovery page */
    .phase-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 56px); /* Full height minus navbar */
        overflow: hidden;
    }
    
    .discovery-top-section {
        padding-bottom: 0.5rem;
        flex-shrink: 0;
    }
    
    .data-sources-container {
        flex: 1;
        overflow-y: auto;
        padding: 0.5rem;
    }
    
    .feedback-container-fixed {
        position: sticky;
        bottom: 0;
        background-color: var(--bs-body-bg);
        border-top: 1px solid var(--bs-border-color);
        padding: 0.75rem;
        z-index: 1000;
    }
    
    /* More compact elements */
    .compact-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    
    .compact-header h1 {
        font-size: 1.5rem;
        margin-bottom: 0;
    }
</style>
<div class="phase-container">
    <!-- Top Section (Header, description, hypothesis) -->
    <div class="discovery-top-section">
        <!-- Compact Phase Header -->
        <div class="compact-header">
            <h1 class="phase-title">Data Discovery</h1>
            <div class="d-flex gap-2">
                <div id="download-data-actions-container">
                    <!-- Download button will be inserted here by script -->
                </div>
                <button class="btn btn-primary" id="generate-data-sources-btn">
                    <i class="bi bi-search me-2"></i>Identify Data Sources
                </button>
                <div class="upload-container">
                    <input type="file" id="data-sources-file-input" class="form-control" accept=".md,.txt" style="display: none;">
                    <button type="button" class="btn btn-outline-secondary" id="upload-data-sources-btn">
                        <i class="bi bi-upload me-1"></i>Upload
                    </button>
                    <small id="upload-data-sources-filename" class="form-text text-muted"></small>
                </div>
            </div>
        </div>
        
        <!-- Compact Phase Description -->
        <p class="phase-description">
            Identify potential data sources based on your research report, hypothesis, and ABLE table.
        </p>

    <!-- Prerequisite Warning -->
    <div id="missing-prerequisites-warning" class="prerequisite-warning" style="display: none;">
        <h5><i class="bi bi-exclamation-triangle-fill me-2"></i>Missing Prerequisites</h5>
        <p class="mb-1">Complete the following phases first:</p>
        <ul id="missing-items-list" class="prerequisite-list"></ul>
    </div>

    <!-- Current Hypothesis Display -->
    <div id="current-hypo-container" style="display: none;" class="mb-3">
        <div class="content-preview-card">
            <div class="content-preview-header">
                <h5><i class="bi bi-lightbulb me-2"></i>Current Hypothesis</h5>
                <small class="text-muted">Data sources will be identified based on this hypothesis</small>
            </div>
            <div id="current-hypo-content" class="content-preview-body" data-raw-markdown=""></div>
        </div>
    </div>

    </div><!-- End of discovery-top-section -->

    <!-- Content Display - Takes up most of the page -->
    <!-- Content Display - Takes up most of the page -->
    <div id="data-sources-container" class="data-sources-container">
        <div class="content-card m-2">
            <div id="data-sources-content" data-raw-markdown="">
                <div id="data-sources-placeholder" class="text-muted fst-italic p-3">
                    The identified data sources will appear here. Click "Identify Data Sources" to begin.
                </div>
            </div>
        </div>
    </div>

    <!-- Feedback Input Area: Fixed at the bottom -->
    <div id="feedback-container" class="feedback-container-fixed">
        <div class="input-group">
            <textarea id="feedback-input" class="form-control" rows="3" placeholder="Provide feedback to refine the data sources."></textarea>
            <button id="send-feedback-btn" class="btn btn-primary">
                <i class="bi bi-send me-2"></i>Send Feedback
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block script %}
/**
 * Data Discovery Phase Manager
 */
class DataDiscoveryManager {
    constructor() {
        this.apiEndpoint = '/api/data-discovery';
        this.contentContainer = document.getElementById('data-sources-content');
        this.downloadContainer = document.getElementById('download-data-actions-container');
        this.sessionStorageKey = 'data_sources_md';

        this.feedbackInput = document.getElementById('feedback-input');
        this.currentHypoContent = document.getElementById('current-hypo-content');

        this.setupEventListeners();
        this.setupUploadHandlers();
        this.initializePage();
    }

    setupEventListeners() {
        document.getElementById('generate-data-sources-btn').addEventListener('click', () => this.handleGenerate());
        document.getElementById('send-feedback-btn').addEventListener('click', () => this.handleSendFeedback());

        this.feedbackInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.handleSendFeedback();
            }
        });
    }

    setupUploadHandlers() {
        const uploadBtn = document.getElementById('upload-data-sources-btn');
        const fileInput = document.getElementById('data-sources-file-input');

        if (uploadBtn && fileInput) {
            uploadBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (event) => this.handleFileUpload(event));
        }
    }

    async initializePage() {
        await this.checkPrerequisites();
        const existingData = sessionStorage.getItem(this.sessionStorageKey);
        if (existingData) {
            this.updateContent(existingData);
        }
    }

    async checkPrerequisites() {
        const prerequisites = [
            { key: 'report_md', name: 'Research Document', url: '/research' },
            { key: 'hypothesis', name: 'Hypothesis', url: '/hypothesis' }
        ];
        const missing = [];
        for (const prereq of prerequisites) {
            let item = sessionStorage.getItem(prereq.key);
            if(prereq.key === 'hypothesis') {
                item = sessionStorage.getItem('refined_hypothesis') || item;
            }
            if (!item) {
                missing.push(prereq);
            }
        }

        const warningContainer = document.getElementById('missing-prerequisites-warning');
        const listElement = document.getElementById('missing-items-list');
        const generateBtn = document.getElementById('generate-data-sources-btn');

        if (missing.length > 0) {
            warningContainer.style.display = 'block';
            listElement.innerHTML = missing.map(p => `<li><a href="${p.url}">${p.name}</a></li>`).join('');
            generateBtn.disabled = true;
            return false;
        } else {
            warningContainer.style.display = 'none';
            generateBtn.disabled = false;
            // Display hypothesis
            const hypothesis = sessionStorage.getItem('refined_hypothesis') || sessionStorage.getItem('hypothesis');
            if(hypothesis) {
                document.getElementById('current-hypo-container').style.display = 'block';
                ContentRenderer.renderMarkdown(hypothesis, this.currentHypoContent);
            }
            return true;
        }
    }

    updateContent(markdown) {
        const placeholder = document.getElementById('data-sources-placeholder');
        if (placeholder) {
            placeholder.style.display = 'none';
        }
        ContentRenderer.renderMarkdown(markdown, this.contentContainer);
        this.contentContainer.dataset.rawMarkdown = markdown;
        sessionStorage.setItem(this.sessionStorageKey, markdown);
        DownloadManager.setupDownloadButton('data-sources-content', 'data_sources', 'download-data-actions-container');
        this.downloadContainer.style.display = 'flex';
    }

    async generateContent(requestBody) {
        UIFeedback.show('loading', 'Identifying data sources... (this may take a moment)');
        try {
            const response = await fetch(this.apiEndpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });
            const data = await response.json();
            if (data.success) {
                this.updateContent(data.data_sources);
            } else {
                throw new Error(data.error || 'Failed to generate content');
            }
        } catch (error) {
            UIFeedback.show('error', 'Error: ' + error.message);
        } finally {
            UIFeedback.hideLoading();
        }
    }

    async handleGenerate() {
        const canProceed = await this.checkPrerequisites();
        if (!canProceed) return;

        const requestBody = {
            hypothesis: sessionStorage.getItem('refined_hypothesis') || sessionStorage.getItem('hypothesis'),
            report_md: sessionStorage.getItem('report_md'),
            able_table_md: sessionStorage.getItem('able_table_md')
        };
        await this.generateContent(requestBody);
    }

    async handleSendFeedback() {
        const feedback = this.feedbackInput.value.trim();
        if (!feedback) {
            UIFeedback.show('error', 'Please enter feedback to refine the data sources.');
            return;
        }

        const currentDataSources = this.contentContainer.dataset.rawMarkdown;
        if (!currentDataSources) {
            UIFeedback.show('error', 'No data sources found to provide feedback on.');
            return;
        }

        const requestBody = {
            hypothesis: sessionStorage.getItem('refined_hypothesis') || sessionStorage.getItem('hypothesis'),
            report_md: sessionStorage.getItem('report_md'),
            able_table_md: sessionStorage.getItem('able_table_md'),
            feedback: feedback,
            current_data_sources: currentDataSources
        };

        await this.generateContent(requestBody);
        this.feedbackInput.value = '';
    }

    handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const uploadFilename = document.getElementById('upload-data-sources-filename');
        if (uploadFilename) {
            uploadFilename.textContent = file.name;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            const content = e.target.result;
            this.updateContent(content);
            if (uploadFilename) {
                uploadFilename.textContent = file.name + ' uploaded successfully!';
                setTimeout(() => { uploadFilename.textContent = ''; }, 3000);
            }
        };
        reader.readAsText(file);
        event.target.value = '';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    window.dataDiscoveryManager = new DataDiscoveryManager();
});

// Initialize the Data Discovery Manager when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    window.dataDiscoveryManager = new DataDiscoveryManager();
});
{% endblock %}
