{% extends "base.html" %}

{% block title %}Data Discovery - PEAK Assistant{% endblock %}

{% set prev_phase_url = "/able-table" %}
{% set prev_phase_name = "ABLE Table" %}
{% set next_phase_url = "/hunt-planning" %}
{% set next_phase_name = "Generate Hunt Plan" %}

{% block nav %}{{ super() }}{% endblock %}

{% block content %}
<div class="phase-container">
    <!-- Compact Phase Header -->
    <div class="phase-header">
        <h1 class="phase-title">Data Discovery</h1>
        <div id="download-data-actions-container" style="display: none;">
            <!-- Download button will be inserted here by script -->
        </div>
    </div>
    
    <!-- Compact Phase Description -->
    <p class="phase-description">
        Identify potential data sources based on your research report, hypothesis, and ABLE table.
    </p>

    <!-- Prerequisite Warning -->
    <div id="missing-prerequisites-warning" class="prerequisite-warning" style="display: none;">
        <h5><i class="bi bi-exclamation-triangle-fill me-2"></i>Missing Prerequisites</h5>
        <p class="mb-1">Complete the following phases first:</p>
        <ul id="missing-items-list" class="prerequisite-list"></ul>
    </div>

    <!-- Compact Action Section -->
    <div class="action-section">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <div class="action-section-title">
                    <i class="bi bi-robot me-2"></i>AI Data Source Identification
                </div>
                <small class="text-muted">AI will analyze your research and hypothesis to identify relevant data sources for hunting.</small>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-primary" id="generate-data-sources-btn">
                    <i class="bi bi-search me-2"></i>Identify Data Sources
                </button>
                <div class="upload-container">
                    <input type="file" id="data-sources-file-input" class="form-control" accept=".md,.txt" style="display: none;">
                    <button type="button" class="btn btn-outline-secondary" id="upload-data-sources-btn">
                        <i class="bi bi-upload me-1"></i>Upload
                    </button>
                    <small id="upload-data-sources-filename" class="form-text text-muted"></small>
                </div>
            </div>
        </div>
    </div>

    <!-- Content Display - Takes up most of the page -->
    <div id="data-sources-section" style="display: none;">
        <div class="content-card">
            <div id="data-sources-content" data-raw-markdown="">
                <p class="text-muted">Data sources will appear here...</p>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block script %}
/**
 * Data Discovery Phase Manager
 */
class DataDiscoveryManager extends PhaseManager {
    constructor() {
        super('data_sources', {
            apiEndpoint: '/api/data-discovery',
            contentContainer: 'data-sources-content',
            downloadContainer: 'download-data-actions-container',
            sessionStorageKey: 'data_sources_md',
            globalContentVar: 'currentDataSourcesMarkdown',
            responseContentKey: 'data_sources',
            loadingMessage: 'Identifying data sources... (this may take a moment)',
            generateButtonTitle: 'Identify data sources for hunting',
            generateButtonText: '<i class="bi bi-search me-2"></i>Identify Data Sources',
            prerequisites: [
                {
                    sessionKey: 'report_md',
                    name: 'Research Document',
                    url: '/research'
                },
                {
                    sessionKey: 'hypothesis',
                    name: 'Hypothesis',
                    url: '/hypothesis'
                },
                {
                    sessionKey: 'able_table_md',
                    name: 'ABLE Table',
                    url: '/able-table'
                }
            ]
        });
        
        this.setupUploadHandlers();
    }
    
    setupEventListeners() {
        const generateBtn = document.getElementById('generate-data-sources-btn');
        if (generateBtn) {
            generateBtn.addEventListener('click', () => this.handleGenerate());
        }
    }
    
    setupUploadHandlers() {
        const uploadBtn = document.getElementById('upload-data-sources-btn');
        const fileInput = document.getElementById('data-sources-file-input');
        
        if (uploadBtn && fileInput) {
            uploadBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (event) => this.handleFileUpload(event));
        }
    }
    
    async handleGenerate() {
        // Check if prerequisites are met before proceeding
        const prereqCheck = await this.checkPrerequisites();
        if (!prereqCheck.valid) {
            UIFeedback.show('error', 'Please complete all prerequisite phases first.');
            return;
        }
        
        // Hide content section before generating
        const dataSourcesSection = document.getElementById('data-sources-section');
        if (dataSourcesSection) {
            dataSourcesSection.style.display = 'none';
        }
        
        try {
            await this.generateContent();
        } catch (error) {
            // Error handling is already done in the parent class
        }
    }
    
    async handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const uploadFilename = document.getElementById('upload-data-sources-filename');
        if (uploadFilename) {
            uploadFilename.textContent = file.name;
        }
        
        const formData = new FormData();
        formData.append('file', file);
        
        try {
            UIFeedback.showLoading('Uploading data sources...');
            
            const response = await fetch('/api/upload-data-sources', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            UIFeedback.hideLoading();
            
            if (data.success) {
                this.updateContent(data.data_sources, true);
                if (uploadFilename) {
                    uploadFilename.textContent = file.name + ' uploaded successfully!';
                    setTimeout(() => { uploadFilename.textContent = file.name; }, 3000);
                }
            } else {
                UIFeedback.show('error', data.error || 'Failed to upload data sources.');
                if (uploadFilename) {
                    uploadFilename.textContent = 'Upload failed. Try again.';
                }
            }
        } catch (error) {
            UIFeedback.hideLoading();
            UIFeedback.show('error', 'Error uploading file: ' + error.message);
            if (uploadFilename) {
                uploadFilename.textContent = 'Upload failed. Try again.';
            }
        }
        
        // Clear file input
        event.target.value = '';
    }
    
    async checkPrerequisites() {
        try {
            const sessionData = await this.apiClient.getSessionData();
            const missing = [];
            
            // Check for research document
            if (!sessionData.report_md || !sessionData.report_md.trim()) {
                missing.push({
                    sessionKey: 'report_md',
                    name: 'Research Document',
                    url: '/research'
                });
            }
            
            // Check for hypothesis (refined or original)
            if (!sessionData.refined_hypothesis && !sessionData.hypothesis) {
                missing.push({
                    sessionKey: 'hypothesis',
                    name: 'Hypothesis',
                    url: '/hypothesis'
                });
            }
            
            // Check for ABLE table
            if (!sessionData.able_table_md) {
                missing.push({
                    sessionKey: 'able_table_md',
                    name: 'ABLE Table',
                    url: '/able-table'
                });
            }
            
            this.updatePrerequisiteUI(missing);
            return { valid: missing.length === 0, missing };
        } catch (error) {
            console.warn('Could not check prerequisites:', error);
            return { valid: true, missing: [] };
        }
    }
    
    updatePrerequisiteUI(missingPrereqs) {
        const warningElement = document.getElementById('missing-prerequisites-warning');
        const generateBtn = document.getElementById('generate-data-sources-btn');
        
        if (missingPrereqs.length > 0 && warningElement) {
            const itemsList = document.getElementById('missing-items-list');
            if (itemsList) {
                itemsList.innerHTML = missingPrereqs.map(prereq => 
                    `<li><a href="${prereq.url}">${prereq.name}</a></li>`
                ).join('');
            }
            warningElement.style.display = 'block';
            
            if (generateBtn) {
                generateBtn.disabled = true;
                generateBtn.classList.add('btn-disabled-warning');
                generateBtn.title = 'Complete all prerequisite phases first';
                generateBtn.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>Prerequisites Required';
            }
        } else {
            if (warningElement) {
                warningElement.style.display = 'none';
            }
            
            if (generateBtn) {
                generateBtn.disabled = false;
                generateBtn.classList.remove('btn-disabled-warning');
                generateBtn.title = 'Identify data sources for hunting';
                generateBtn.innerHTML = '<i class="bi bi-search me-2"></i>Identify Data Sources';
            }
        }
    }
    
    updateContent(markdown, showSection = true) {
        // Store content in global variables
        window.currentDataSourcesMarkdown = markdown;
        
        const contentDiv = document.getElementById(this.config.contentContainer);
        const dataSourcesSection = document.getElementById('data-sources-section');
        
        if (markdown && markdown.trim()) {
            // Render content using the global renderMarkdown function
            if (typeof renderMarkdown === 'function') {
                renderMarkdown(markdown, contentDiv);
            } else {
                contentDiv.innerHTML = markdown;
            }
            
            // Store in session storage
            sessionStorage.setItem(this.config.sessionStorageKey, markdown);
            
            // Only show the section if explicitly requested (user action)
            if (showSection && dataSourcesSection) {
                dataSourcesSection.style.display = 'block';
            }
        } else {
            contentDiv.innerHTML = '<p class="text-muted">Data sources will appear here...</p>';
            sessionStorage.removeItem(this.config.sessionStorageKey);
            
            // Hide the section when no content
            if (dataSourcesSection) {
                dataSourcesSection.style.display = 'none';
            }
        }
        
        // Setup download button
        if (markdown && markdown.trim()) {
            DownloadManager.setupDownloadButton(
                this.config.contentContainer,
                'data_sources',
                this.config.downloadContainer
            );
            
            const downloadContainer = document.getElementById(this.config.downloadContainer);
            if (downloadContainer) {
                downloadContainer.style.display = 'flex';
            }
        } else {
            const downloadContainer = document.getElementById(this.config.downloadContainer);
            if (downloadContainer) {
                downloadContainer.style.display = 'none';
            }
        }
        
        // Check navigation button state
        this.checkNavigationButtonState();
    }
    
    checkNavigationButtonState() {
        // Check if hunt planning prerequisites are met
        const researchDone = sessionStorage.getItem('report_md')?.trim();
        const hypothesisDone = sessionStorage.getItem('refined_hypothesis')?.trim() || sessionStorage.getItem('current_hypothesis')?.trim();
        const ableDone = sessionStorage.getItem('able_table_md')?.trim();
        const discoveryDone = sessionStorage.getItem('data_sources_md')?.trim();

        const allPrerequisitesMet = researchDone && hypothesisDone && ableDone && discoveryDone;
        
        // Find the navigation button (hunt planning "next" button)
        const navButtons = document.querySelectorAll('.top-navigation .btn-outline-primary');
        navButtons.forEach(btn => {
            if (btn.href && btn.href.includes('/hunt-planning')) {
                if (!allPrerequisitesMet) {
                    btn.classList.add('disabled');
                    btn.style.opacity = '0.6';
                    btn.style.cursor = 'not-allowed';
                    btn.addEventListener('click', function(e) {
                        if (this.classList.contains('disabled')) {
                            e.preventDefault();
                            return false;
                        }
                    });
                } else {
                    btn.classList.remove('disabled');
                    btn.style.opacity = '';
                    btn.style.cursor = '';
                }
            }
        });
    }
    
    onContentGenerated(response) {
        // Show content container
        const dataSourcesSection = document.getElementById('data-sources-section');
        if (dataSourcesSection) {
            dataSourcesSection.style.display = 'block';
        }
        
        // Setup download button
        DownloadManager.setupDownloadButton(
            this.config.contentContainer,
            'data_sources',
            this.config.downloadContainer
        );
        
        // Show download container
        const downloadContainer = document.getElementById(this.config.downloadContainer);
        if (downloadContainer) {
            downloadContainer.style.display = 'flex';
        }
    }
    
    async initialize() {
        await super.initialize();
        
        // Load existing content but don't show section on initial load
        try {
            const response = await fetch(this.config.apiEndpoint, {
                method: 'GET',
                headers: { 'Accept': 'application/json' }
            });
            
            const data = await response.json();
            if (data.data_sources_md) {
                // Load content but don't show the section until user takes action
                this.updateContent(data.data_sources_md, false);
            }
        } catch (error) {
            console.warn('Could not load existing data sources:', error);
        }
        
        // Check prerequisites on initialization
        await this.checkPrerequisites();
    }
}

// Initialize the Data Discovery Manager when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    window.dataDiscoveryManager = new DataDiscoveryManager();
});
{% endblock %}
