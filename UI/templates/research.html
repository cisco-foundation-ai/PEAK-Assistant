{% extends "base.html" %}

{% block title %}Topic Research - PEAK Assistant{% endblock %}

{% set prev_phase_url = None %}
{% set prev_phase_name = None %}
{% set next_phase_url = url_for('hypothesis_page') %}
{% set next_phase_name = "Hypothesis Generation" %}

{% block nav %}{{ super() }}{% endblock %}

{% block content %}
<h2>Topic Research</h2>
<p class="mb-4">Enter a topic, threat actor technique, or behavior to generate a research report. You can also upload an existing report.</p>

<div class="row mb-3">
    <div class="col-md-9">
        <label for="topic-input" class="form-label">Research Topic:</label>
        <input type="text" id="topic-input" class="form-control" placeholder="e.g., Kerberoasting, Initial Access via Phishing">
    </div>
    <div class="col-md-3 align-self-end">
        <button id="generate-btn" class="btn btn-primary w-100">Generate Report</button>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-12">
        <label for="upload-report-file" class="form-label">Or Upload Report (MD or TXT):</label>
        <div class="input-group">
            <input type="file" class="form-control" id="upload-report-file" accept=".md,.txt">
            <button id="upload-report-btn" class="btn btn-outline-secondary">Upload</button>
        </div>
        <small id="upload-report-filename" class="form-text text-muted"></small>
    </div>
</div>

<div id="report-actions-container" class="d-flex justify-content-end mb-2" style="display: none;">
    <!-- Download button will be inserted here by script -->
</div>

<div id="report-container" style="display: none;">
    <h3>Research Report</h3>
    <div id="report-content" class="border rounded p-3 mb-3" data-raw-markdown=""></div>
</div>

{% endblock %}

{% block script %}
// Store current report markdown for download
window.currentReportMarkdown = '';

document.addEventListener('DOMContentLoaded', function() {
    const generateBtn = document.getElementById('generate-btn');
    const topicInput = document.getElementById('topic-input');
    const reportContainer = document.getElementById('report-container');
    const reportContent = document.getElementById('report-content');
    const reportActionsContainer = document.getElementById('report-actions-container');
    const uploadReportFile = document.getElementById('upload-report-file');
    const uploadReportBtn = document.getElementById('upload-report-btn');
    const uploadReportFilename = document.getElementById('upload-report-filename');

    // Setup combined download button
    setupDownloadButton('report-content', 'research_report', 'report-actions-container');

    generateBtn.addEventListener('click', function() {
        const topic = topicInput.value.trim();
        if (!topic) {
            showError('Please enter a research topic.');
            return;
        }
        
        hideError();
        showLoading('Generating research report... (this may take several minutes)');
        
        const retryCount = document.getElementById('retry-count').value;
        const verboseMode = document.getElementById('debug-mode')?.checked || false;
        
        fetch('/api/research', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                topic: topic, 
                retry_count: retryCount,
                verbose_mode: verboseMode 
            })
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                window.currentReportMarkdown = data.report;
                reportContent.dataset.rawMarkdown = data.report; // Store for download
                renderMarkdown(data.report, reportContent);
                reportContainer.style.display = 'block';
                reportActionsContainer.style.display = 'flex'; // Show download button
                // Store in sessionStorage for persistence across page loads (optional)
                sessionStorage.setItem('last_topic', topic);
                sessionStorage.setItem('report_md', data.report);
            } else {
                showError('Error generating report: ' + data.error, data.detail);
            }
        })
        .catch(error => {
            hideLoading();
            showError('Network error: ' + error.message);
        });
    });

    topicInput.addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            generateBtn.click();
        }
    });

    uploadReportBtn.addEventListener('click', function() {
        const file = uploadReportFile.files[0];
        if (!file) {
            showError('Please select a file to upload.');
            return;
        }

        hideError();
        showLoading('Uploading report...');
        const formData = new FormData();
        formData.append('file', file);

        fetch('/api/upload-report', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                window.currentReportMarkdown = data.report;
                reportContent.dataset.rawMarkdown = data.report; // Store for download
                renderMarkdown(data.report, reportContent);
                reportContainer.style.display = 'block';
                reportActionsContainer.style.display = 'flex'; // Show download button
                topicInput.value = '[Uploaded Report]';
                uploadReportFilename.textContent = file.name;
                sessionStorage.setItem('report_md', data.report);
                sessionStorage.setItem('last_topic', '[Uploaded]');
            } else {
                showError('Error uploading report: ' + data.error);
            }
        })
        .catch(error => {
            hideLoading();
            showError('Network error during upload: ' + error.message);
        });
    });
    
    uploadReportFile.addEventListener('change', function() {
        if (this.files.length > 0) {
            uploadReportFilename.textContent = this.files[0].name;
        } else {
            uploadReportFilename.textContent = '';
        }
    });

    // Initialize from session data (or sessionStorage for better UX)
    function loadSessionData() {
        const storedReport = sessionStorage.getItem('report_md');
        const storedTopic = sessionStorage.getItem('last_topic');

        if (storedReport) {
            window.currentReportMarkdown = storedReport;
            reportContent.dataset.rawMarkdown = storedReport;
            renderMarkdown(storedReport, reportContent);
            reportContainer.style.display = 'block';
            reportActionsContainer.style.display = 'flex';
            if (storedTopic) {
                topicInput.value = storedTopic;
            }
        } else {
            // Fallback to server session if sessionStorage is empty (e.g. first load)
            fetch('/api/debug-info')
            .then(response => response.json())
            .then(debugData => {
                const session = debugData.session_data || {};
                if (session.report_md) {
                    window.currentReportMarkdown = session.report_md;
                    reportContent.dataset.rawMarkdown = session.report_md;
                    renderMarkdown(session.report_md, reportContent);
                    reportContainer.style.display = 'block';
                    reportActionsContainer.style.display = 'flex';
                    if (session.last_topic) {
                        topicInput.value = session.last_topic;
                    }
                    // Populate sessionStorage for next time
                    sessionStorage.setItem('report_md', session.report_md);
                    if(session.last_topic) sessionStorage.setItem('last_topic', session.last_topic);
                }
            })
            .catch(error => console.error("Error fetching initial session data:", error));
        }
    }
    loadSessionData();

});
{% endblock %}
