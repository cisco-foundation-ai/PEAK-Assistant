{% extends "base.html" %}

{% block title %}Topic Research - PEAK Assistant{% endblock %}

{% set prev_phase_url = None %}
{% set prev_phase_name = None %}
{% set next_phase_url = url_for('hypothesis_page') %}
{% set next_phase_name = "Hypothesis Generation" %}

{% block nav %}{{ super() }}{% endblock %}

{% block content %}
<div class="phase-container">
    <!-- Compact Phase Header -->
    <div class="phase-header">
        <h1 class="phase-title">Topic Research</h1>
        <div id="report-actions-container" style="display: none;">
            <!-- Download button will be inserted here by script -->
        </div>
    </div>
    
    <!-- Compact Phase Description -->
    <p class="phase-description">
        Enter a topic, threat actor technique, or behavior to generate a research report, or upload an existing report.
    </p>

    <!-- Create Research Report Section -->
    <div class="action-section mb-4">
        <div class="action-section-title mb-3">
            <i class="bi bi-robot me-2"></i>Create Research Report
        </div>
        
        <!-- Combined Input and Upload Section for Better Space Usage -->
        <div class="row g-3">
            <!-- Research Topic Section -->
            <div class="col-md-8">
                <div class="input-group">
                    <input type="text" id="topic-input" class="form-control" 
                           placeholder="e.g., Kerberoasting, Initial Access via Phishing">
                    <button id="generate-btn" class="btn btn-primary">
                        <i class="bi bi-magic me-2"></i>Generate Report
                    </button>
                </div>
            </div>
            
            <!-- Upload Section -->
            <div class="col-md-4">
                <input type="file" id="upload-report-file" class="form-control" accept=".md,.txt" style="display: none;">
                <button type="button" id="upload-report-btn" class="btn btn-outline-secondary w-100">
                    <i class="bi bi-upload me-2"></i>Upload Report
                </button>
                <small id="upload-report-filename" class="form-text text-muted"></small>
            </div>
        </div>
    </div>

    <!-- Content Display - Takes up most of the page -->
    <div id="report-container" style="display: none;">
        <div class="content-card">
            <div id="report-content" data-raw-markdown=""></div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
/**
 * Research Phase Manager
 */
class ResearchManager extends PhaseManager {
    constructor() {
        super('research', {
            apiEndpoint: '/api/research',
            contentContainer: 'report-content',
            downloadContainer: 'report-actions-container',
            sessionStorageKey: 'report_md',
            globalContentVar: 'currentReportMarkdown',
            responseContentKey: 'report',
            loadingMessage: 'Generating research report... (this may take several minutes)',
            generateButtonTitle: 'Generate comprehensive research report',
            generateButtonText: '<i class="bi bi-magic me-2"></i>Generate Report'
        });
    }
    
    displayContent(content) {
        // Override parent displayContent to handle report container visibility
        const contentElement = document.getElementById(this.config.contentContainer);
        const downloadContainer = document.getElementById(this.config.downloadContainer);
        const reportContainer = document.getElementById('report-container');
        
        if (content && content.trim()) {
            if (this.config.globalContentVar) {
                window[this.config.globalContentVar] = content;
            }
            contentElement.dataset.rawMarkdown = content;
            ContentRenderer.renderMarkdown(content, contentElement);
            
            // Show the report container
            if (reportContainer) {
                reportContainer.style.display = 'block';
            }
            
            if (downloadContainer) {
                downloadContainer.style.display = 'flex';
            }
        } else {
            ContentRenderer.clearContent(contentElement);
            
            // Hide the report container
            if (reportContainer) {
                reportContainer.style.display = 'none';
            }
            
            if (downloadContainer) {
                downloadContainer.style.display = 'none';
            }
        }
    }
    
    setupEventListeners() {
        const generateBtn = document.getElementById('generate-btn');
        const topicInput = document.getElementById('topic-input');
        const uploadReportBtn = document.getElementById('upload-report-btn');
        const uploadReportFile = document.getElementById('upload-report-file');
        
        if (generateBtn) {
            generateBtn.addEventListener('click', () => this.handleGenerate());
        }
        
        if (topicInput) {
            topicInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    this.handleGenerate();
                }
            });
        }
        
        if (uploadReportBtn) {
            uploadReportBtn.addEventListener('click', () => {
                uploadReportFile.click(); // Trigger hidden file input
            });
        }
        
        if (uploadReportFile) {
            uploadReportFile.addEventListener('change', () => {
                const file = uploadReportFile.files[0];
                if (!file) {
                    return;
                }
                
                const uploadReportFilename = document.getElementById('upload-report-filename');
                uploadReportFilename.textContent = file.name;
                
                // Auto-upload when file is selected (like ABLE table)
                this.handleUpload();
            });
        }
    }
    
    async handleGenerate() {
        const topicInput = document.getElementById('topic-input');
        const topic = topicInput.value.trim();
        
        if (!topic) {
            UIFeedback.show('error', 'Please enter a research topic.');
            return;
        }
        
        try {
            const response = await this.generateContent({ topic });
            
            // Store topic for reference
            sessionStorage.setItem('last_topic', topic);
        } catch (error) {
            // Error handling is already done in the parent class
        }
    }
    
    async handleUpload() {
        const uploadReportFile = document.getElementById('upload-report-file');
        const uploadReportFilename = document.getElementById('upload-report-filename');
        const file = uploadReportFile.files[0];
        
        if (!file) {
            return;
        }

        UIFeedback.hideError();
        UIFeedback.show('loading', 'Uploading report...');
        
        try {
            const formData = new FormData();
            formData.append('file', file);
            
            const response = await this.apiClient.uploadFile('/api/upload-report', formData);
            UIFeedback.hideLoading();
            
            if (response.success) {
                // Use parent's displayContent method which handles everything properly
                this.displayContent(response.content);
                sessionStorage.setItem(this.config.sessionStorageKey, response.content);
                
                uploadReportFilename.textContent = file.name + ' uploaded successfully!';
                setTimeout(() => { uploadReportFilename.textContent = file.name; }, 3000); // Reset after a few seconds
                
                this.onContentGenerated(response);
            } else {
                throw new Error(response.error || 'Upload failed');
            }
        } catch (error) {
            UIFeedback.hideLoading();
            UIFeedback.show('error', 'Upload error: ' + error.message, error.detail);
            uploadReportFilename.textContent = 'Upload failed. Try again.';
        }
    }
    
    onContentGenerated(response) {
        // Setup download button - container visibility is handled by displayContent
        DownloadManager.setupDownloadButton(
            this.config.contentContainer,
            'research_report',
            this.config.downloadContainer
        );
    }
}

// Initialize the Research Manager when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    window.researchManager = new ResearchManager();
});
{% endblock %}
