{% extends "base.html" %}

{% block title %}Topic Research - PEAK Assistant{% endblock %}

{% set prev_phase_url = None %}
{% set prev_phase_name = None %}
{% set next_phase_url = url_for('hypothesis_page') %}
{% set next_phase_name = "Hypothesis Generation" %}

{% block nav %}{{ super() }}{% endblock %}

{% block content %}
<div class="phase-container">
    <!-- Phase Header -->
    <div class="phase-header">
        <h1 class="phase-title">Topic Research</h1>
        <div id="report-actions-container" style="display: none;">
            <!-- Download button will be inserted here by script -->
        </div>
    </div>
    
    <!-- Phase Description -->
    <p class="phase-description">
        Enter a topic, threat actor technique, or behavior to generate a research report. You can also upload an existing report.
    </p>

    <!-- Input Section -->
    <div class="action-section">
        <div class="action-section-title">
            <i class="bi bi-search me-2"></i>Research Topic
        </div>
        <div class="form-section">
            <div class="input-group-enhanced mb-3">
                <div class="flex-grow-1">
                    <label for="topic-input" class="form-label">Research Topic:</label>
                    <input type="text" id="topic-input" class="form-control form-control-lg" 
                           placeholder="e.g., Kerberoasting, Initial Access via Phishing">
                </div>
                <button id="generate-btn" class="btn btn-primary btn-lg">
                    <i class="bi bi-magic me-2"></i>Generate Report
                </button>
            </div>
        </div>
    </div>

    <!-- Upload Section -->
    <div class="action-section">
        <div class="action-section-title">
            <i class="bi bi-upload me-2"></i>Upload Existing Report
        </div>
        <div class="form-section">
            <label for="upload-report-file" class="form-label">Upload Report (MD or TXT):</label>
            <div class="input-group">
                <input type="file" class="form-control" id="upload-report-file" accept=".md,.txt">
                <button id="upload-report-btn" class="btn btn-outline-secondary">
                    <i class="bi bi-upload me-2"></i>Upload
                </button>
            </div>
            <small id="upload-report-filename" class="form-text text-muted"></small>
        </div>
    </div>

    <!-- Content Display -->
    <div id="report-container" style="display: none;">
        <div class="content-card">
            <div id="report-content" data-raw-markdown=""></div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
/**
 * Research Phase Manager
 */
class ResearchManager extends PhaseManager {
    constructor() {
        super('research', {
            apiEndpoint: '/api/research',
            contentContainer: 'report-content',
            downloadContainer: 'report-actions-container',
            sessionStorageKey: 'report_md',
            globalContentVar: 'currentReportMarkdown',
            responseContentKey: 'report',
            loadingMessage: 'Generating research report... (this may take several minutes)',
            generateButtonTitle: 'Generate comprehensive research report',
            generateButtonText: '<i class="bi bi-magic me-2"></i>Generate Report'
        });
    }
    
    setupEventListeners() {
        const generateBtn = document.getElementById('generate-btn');
        const topicInput = document.getElementById('topic-input');
        const uploadReportBtn = document.getElementById('upload-report-btn');
        const uploadReportFile = document.getElementById('upload-report-file');
        
        if (generateBtn) {
            generateBtn.addEventListener('click', () => this.handleGenerate());
        }
        
        if (topicInput) {
            topicInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    this.handleGenerate();
                }
            });
        }
        
        if (uploadReportBtn) {
            uploadReportBtn.addEventListener('click', () => this.handleUpload());
        }
        
        if (uploadReportFile) {
            uploadReportFile.addEventListener('change', () => this.updateFilename());
        }
    }
    
    async handleGenerate() {
        const topicInput = document.getElementById('topic-input');
        const topic = topicInput.value.trim();
        
        if (!topic) {
            UIFeedback.show('error', 'Please enter a research topic.');
            return;
        }
        
        try {
            const response = await this.generateContent({ topic });
            
            // Store topic for reference
            sessionStorage.setItem('last_topic', topic);
        } catch (error) {
            // Error handling is already done in the parent class
        }
    }
    
    async handleUpload() {
        const uploadReportFile = document.getElementById('upload-report-file');
        const file = uploadReportFile.files[0];
        
        if (!file) {
            UIFeedback.show('error', 'Please select a file to upload.');
            return;
        }

        UIFeedback.hideError();
        UIFeedback.show('loading', 'Uploading report...');
        
        try {
            const formData = new FormData();
            formData.append('file', file);
            
            const response = await this.apiClient.uploadFile('/api/upload-report', formData);
            UIFeedback.hideLoading();
            
            if (response.success) {
                this.displayContent(response.content);
                sessionStorage.setItem(this.config.sessionStorageKey, response.content);
                
                this.onContentGenerated(response);
            } else {
                throw new Error(response.error || 'Upload failed');
            }
        } catch (error) {
            UIFeedback.hideLoading();
            UIFeedback.show('error', 'Upload error: ' + error.message, error.detail);
        }
    }
    
    updateFilename() {
        const uploadReportFile = document.getElementById('upload-report-file');
        const uploadReportFilename = document.getElementById('upload-report-filename');
        
        if (uploadReportFile.files[0] && uploadReportFilename) {
            uploadReportFilename.textContent = `Selected: ${uploadReportFile.files[0].name}`;
        } else if (uploadReportFilename) {
            uploadReportFilename.textContent = '';
        }
    }
    
    onContentGenerated(response) {
        // Show content container
        const reportContainer = document.getElementById('report-container');
        if (reportContainer) {
            reportContainer.style.display = 'block';
        }
        
        // Setup download button
        DownloadManager.setupDownloadButton(
            this.config.contentContainer,
            'research_report',
            this.config.downloadContainer
        );
        
        // Show download container
        const downloadContainer = document.getElementById(this.config.downloadContainer);
        if (downloadContainer) {
            downloadContainer.style.display = 'flex';
        }
    }
}

// Initialize the Research Manager when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    window.researchManager = new ResearchManager();
});
{% endblock %}
