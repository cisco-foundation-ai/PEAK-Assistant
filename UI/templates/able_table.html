{% extends "base.html" %}

{% set prev_phase_url = "/refinement" %}
{% set prev_phase_name = "Hypothesis Refinement (Optional)" %}
{% set next_phase_url = "/data-discovery" %}
{% set next_phase_name = "Data Discovery" %}

{% block nav %}{{ super() }}{% endblock %}

{% block content %}
<h2>Generate ABLE Table</h2>
<p class="mb-4">This phase generates an ABLE (Activity, Behavior, Linkages, Environment) table based on the final hypothesis. You can also upload an existing ABLE table.</p>

<div id="no-hypothesis-warning" class="alert alert-warning mb-4" style="display: none;">
    <strong>Note:</strong> No hypothesis found. Please generate or select a hypothesis in the Hypothesis Phase first.
</div>

<div id="final-hypo-container" style="display: none;" class="mb-4">
    <h4>Final Hypothesis</h4>
    <p class="text-muted small">The ABLE table will be generated based on this hypothesis. If this is not the desired hypothesis, please go back to the Hypothesis or Refinement phase.</p>
    <div id="final-hypo-content" class="border rounded p-3" data-raw-markdown=""></div>
</div>

<div class="row mb-3">
    <div class="col-md-9">
        <button id="generate-able-btn" class="btn btn-primary w-100">Generate ABLE Table</button>
    </div>
    <div class="col-md-3">
        <label for="upload-able-table-file" class="form-label visually-hidden">Upload ABLE Table File</label>
        <input type="file" id="upload-able-table-file" class="form-control" accept=".md,.txt" style="display: none;">
        <button type="button" id="upload-able-table-btn" class="btn btn-outline-secondary w-100">Upload ABLE Table</button>
        <small id="upload-able-table-filename" class="form-text text-muted"></small>
    </div>
</div>

<!-- Container for the combined download button -->
<div id="download-able-actions-container" class="d-flex justify-content-end mb-2" style="display: none;">
    <!-- Download button will be inserted here by script -->
</div>

<div id="able-table-container" style="display: none;">
    <h3>ABLE Table</h3>
    <div id="able-table-content" class="border rounded p-3 mb-3" data-raw-markdown=""></div>
</div>

{% endblock %}

{% block script %}
// Store current ABLE table markdown for download
window.currentAbleTableMarkdown = '';

document.addEventListener('DOMContentLoaded', function() {
    const generateAbleBtn = document.getElementById('generate-able-btn');
    const ableTableContainer = document.getElementById('able-table-container');
    const ableTableContent = document.getElementById('able-table-content');
    const finalHypoContainer = document.getElementById('final-hypo-container');
    const finalHypoContent = document.getElementById('final-hypo-content');
    const noHypothesisWarning = document.getElementById('no-hypothesis-warning');
    const uploadAbleTableFile = document.getElementById('upload-able-table-file');
    const uploadAbleTableBtn = document.getElementById('upload-able-table-btn');
    const uploadAbleTableFilename = document.getElementById('upload-able-table-filename');
    const downloadAbleActionsContainer = document.getElementById('download-able-actions-container');

    // Setup combined download button
    setupDownloadButton('able-table-content', 'able_table', 'download-able-actions-container');

    function updateUIDisplay(sessionData) {
        const hypothesisToUse = sessionData.refined_hypothesis || sessionData.hypothesis;

        if (!hypothesisToUse || hypothesisToUse.trim() === '') {
            noHypothesisWarning.style.display = 'block';
            finalHypoContainer.style.display = 'none';
            ableTableContainer.style.display = 'none';
            downloadAbleActionsContainer.style.display = 'none';
            generateAbleBtn.disabled = true;
        } else {
            noHypothesisWarning.style.display = 'none';
            generateAbleBtn.disabled = false;
            finalHypoContent.dataset.rawMarkdown = hypothesisToUse;
            renderMarkdown(hypothesisToUse, finalHypoContent);
            finalHypoContainer.style.display = 'block';
        }

        if (sessionData.able_table_md && sessionData.able_table_md.trim() !== '') {
            window.currentAbleTableMarkdown = sessionData.able_table_md;
            ableTableContent.dataset.rawMarkdown = sessionData.able_table_md;
            renderMarkdown(sessionData.able_table_md, ableTableContent);
            ableTableContainer.style.display = 'block';
            downloadAbleActionsContainer.style.display = 'flex';
            sessionStorage.setItem('able_table_md', sessionData.able_table_md);
        } else {
            ableTableContainer.style.display = 'none';
            downloadAbleActionsContainer.style.display = 'none';
            window.currentAbleTableMarkdown = '';
            ableTableContent.dataset.rawMarkdown = '';
            sessionStorage.removeItem('able_table_md');
        }
        if (typeof checkHuntPlanningPrerequisites === 'function') {
            checkHuntPlanningPrerequisites();
        }
    }

    function loadInitialData() {
        showLoading('Loading ABLE Table data...');
        fetch('/api/debug-info')
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.session_data) {
                    updateUIDisplay(data.session_data);
                } else {
                    updateUIDisplay({});
                }
            })
            .catch(error => {
                hideLoading();
                showError('Error loading initial data: ' + error.message);
                updateUIDisplay({}); 
            });
    }

    generateAbleBtn.addEventListener('click', function() {
        hideError();
        showLoading('Generating ABLE Table...');
        
        let retryCount = 3; // Default value
        const storedRetryCount = localStorage.getItem('retry-count-page');
        if (storedRetryCount) {
            const parsedRetryCount = parseInt(storedRetryCount, 10);
            if (!isNaN(parsedRetryCount)) {
                retryCount = parsedRetryCount;
            } else {
                console.warn('Invalid retry count in localStorage for ABLE table, using default (3).');
            }
        }
        
        fetch('/api/able-table', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                retry_count: retryCount
            })
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                window.currentAbleTableMarkdown = data.able_table;
                ableTableContent.dataset.rawMarkdown = data.able_table;
                renderMarkdown(data.able_table, ableTableContent);
                ableTableContainer.style.display = 'block';
                downloadAbleActionsContainer.style.display = 'flex';
                // Persist to session by re-fetching or specific call if available
                // For now, assume backend saves it and reload initial data to reflect
                loadInitialData(); 
            } else {
                let errorDetail = data.detail || null;
                if (data.error && data.error.includes('OpenAI API internal server error')) {
                    showError(
                        'OpenAI API internal server error. This is an issue with OpenAI\\\'s servers. Maximum retry attempts reached. \\n\\nTip: You can try again later, refine your hypothesis, or increase the retry count.',
                        errorDetail
                    );
                } else {
                    showError('Error generating ABLE table: ' + (data.error || 'Unknown error'), errorDetail);
                }
            }
        })
        .catch(error => {
            hideLoading();
            showError('Network error: ' + error.message);
        });
    });

    uploadAbleTableBtn.addEventListener('click', function() {
        uploadAbleTableFile.click(); // Trigger hidden file input
    });

    uploadAbleTableFile.addEventListener('change', function() {
        const file = this.files[0];
        if (!file) {
            return;
        }
        uploadAbleTableFilename.textContent = file.name;
        hideError();
        showLoading('Uploading ABLE table...');
        const formData = new FormData();
        formData.append('file', file);

        fetch('/api/upload-able-table', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                window.currentAbleTableMarkdown = data.able_table;
                ableTableContent.dataset.rawMarkdown = data.able_table;
                renderMarkdown(data.able_table, ableTableContent);
                ableTableContainer.style.display = 'block';
                downloadAbleActionsContainer.style.display = 'flex';
                uploadAbleTableFilename.textContent = file.name + ' uploaded successfully!';
                setTimeout(() => { uploadAbleTableFilename.textContent = file.name; }, 3000); // Reset after a few seconds
                 // Refresh data from server to ensure consistency
                loadInitialData();
            } else {
                showError('Error uploading ABLE table: ' + data.error);
                uploadAbleTableFilename.textContent = 'Upload failed. Try again.';
            }
        })
        .catch(error => {
            hideLoading();
            showError('Network error during upload: ' + error.message);
            uploadAbleTableFilename.textContent = 'Upload failed. Try again.';
        });
    });

    // Initial load
    loadInitialData();
});
{% endblock %}
