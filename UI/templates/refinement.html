{% extends "base.html" %}

{% block title %}Hypothesis Refinement - PEAK Assistant{% endblock %}

{% set prev_phase_url = url_for('pages.hypothesis_page') %}
{% set prev_phase_name = 'Hypothesis Generation' %}
{% set next_phase_url = url_for('pages.able_table_page') %}
{% set next_phase_name = "ABLE Table Generation" %}

{% block nav %}{{ super() }}{% endblock %}

{% block content %}
<div class="phase-container d-flex flex-column" style="height: calc(100vh - 80px);">
    <!-- Header -->
    <div class="phase-header d-flex justify-content-between align-items-center">
        <h1 class="phase-title mb-0">Hypothesis Refinement</h1>
        <button id="refine-btn" class="btn btn-primary">
            <i class="bi bi-robot me-2"></i>Refine Hypothesis
        </button>
    </div>

    <!-- Compact Phase Description -->
    <p class="phase-description">
        Review the current hypothesis. Provide feedback to the AI assistant to refine it.
    </p>

    <!-- Comprehensive Prerequisites Warning -->
    <div id="missing-prerequisites-warning" class="prerequisite-warning" style="display: none;">
        <h5><i class="bi bi-exclamation-triangle-fill me-2"></i>Missing Prerequisites</h5>
        <p class="mb-1">Complete the following phases first:</p>
        <ul id="missing-items-list" class="prerequisite-list"></ul>
    </div>

    <!-- Main Content Area: Use flex-grow-1 to take up available space -->
    <div class="flex-grow-1" style="overflow-y: auto;">
        <!-- Hypothesis Display Area (always visible) -->
        <!-- Current Hypothesis Display Area -->
        <div class="content-card p-3 m-3">
            <h5 class="text-muted">Current Hypothesis</h5>
            <div id="hypothesis-content" data-raw-hypothesis=""></div>
            <div id="no-hypothesis-placeholder" class="text-muted fst-italic" style="display: none;">
                No hypothesis available. Please generate one on the previous page.
            </div>
        </div>
    </div>

    <!-- Feedback Input Area: Stays at the bottom (always visible) -->
    <div id="feedback-container" class="action-section mt-auto p-3">
        <div class="input-group">
            <textarea id="feedback-input" class="form-control" rows="3" placeholder="Provide feedback to refine the hypothesis."></textarea>
            <button id="send-feedback-btn" class="btn btn-primary">
                <i class="bi bi-send me-2"></i>Send Feedback
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}

class RefinementManager {
    constructor() {
        this.hypothesisContent = document.getElementById('hypothesis-content');
        this.feedbackInput = document.getElementById('feedback-input');
        this.missingPrerequisitesWarning = document.getElementById('missing-prerequisites-warning');
        this.missingItemsList = document.getElementById('missing-items-list');

        this.setupEventListeners();
        this.loadInitialData();
    }

    setupEventListeners() {
        document.getElementById('refine-btn').addEventListener('click', () => this.handleRefine());
        document.getElementById('send-feedback-btn').addEventListener('click', () => this.handleSendFeedback());

    }

    loadInitialData() {
        // Check prerequisites (now async and handles loading internally)
        this.checkPrerequisites();
    }

    checkPrerequisites() {
        // Check server-side session data like the hypothesis page does
        fetch('/api/debug-info')
            .then(r => r.json())
            .then(data => {
                const missingItems = [];
                
                // Check for research report (same as hypothesis page)
                if (!data?.session_data?.report_md) {
                    missingItems.push('<li><a href="/research" class="alert-link">Research Report</a> - Generate a comprehensive research report first</li>');
                }
                
                // Check for hypothesis
                const hypothesis = sessionStorage.getItem('refined_hypothesis') || sessionStorage.getItem('hypothesis');
                if (!hypothesis || !hypothesis.trim()) {
                    missingItems.push('<li><a href="/hypothesis" class="alert-link">Hypothesis</a> - Create a hypothesis to refine</li>');
                }
                
                if (missingItems.length > 0) {
                    this.missingItemsList.innerHTML = missingItems.join('');
                    this.missingPrerequisitesWarning.style.display = 'block';
                    // Hide the main content when prerequisites are missing
                    document.querySelector('.flex-grow-1').style.display = 'none';
                    document.getElementById('feedback-container').style.display = 'none';
                } else {
                    this.missingPrerequisitesWarning.style.display = 'none';
                    document.querySelector('.flex-grow-1').style.display = 'block';
                    document.getElementById('feedback-container').style.display = 'block';
                    
                    // Prerequisites met, load the hypothesis
                    const hypothesis = sessionStorage.getItem('refined_hypothesis') || sessionStorage.getItem('hypothesis');
                    this.displayHypothesis(hypothesis);
                }
            })
            .catch(error => {
                console.error('Failed to check prerequisites:', error);
                // On error, assume prerequisites are not met
                this.missingPrerequisitesWarning.style.display = 'block';
                document.querySelector('.flex-grow-1').style.display = 'none';
                document.getElementById('feedback-container').style.display = 'none';
            });
    }

    displayHypothesis(hypothesis) {
        const isHypothesisPresent = hypothesis && hypothesis.trim();
        const noHypothesisPlaceholder = document.getElementById('no-hypothesis-placeholder');

        if (isHypothesisPresent) {
            this.hypothesisContent.style.display = 'block';
            noHypothesisPlaceholder.style.display = 'none';

            ContentRenderer.renderMarkdown(hypothesis, this.hypothesisContent);
            this.hypothesisContent.dataset.rawHypothesis = hypothesis;
            // Always save the latest version as the refined_hypothesis
            sessionStorage.setItem('refined_hypothesis', hypothesis);
        } else {
            this.hypothesisContent.style.display = 'none';
            noHypothesisPlaceholder.style.display = 'block';
        }
    }

    async fetchRefinement(hypothesis, feedback) {
        const endpoint = '/api/refine';
        const payload = { hypothesis, feedback };
        console.log('Sending to /api/refine:', payload);
        const loadingMessage = feedback ? 'Refining based on your feedback...' : 'Getting initial refinement...';

        UIFeedback.show('loading', loadingMessage);
        try {
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await response.json();
            if (data.success) {
                // Directly update the main hypothesis
                this.displayHypothesis(data.refined_hypothesis);
                if (feedback) {
                    this.feedbackInput.value = ''; // Clear feedback input on success
                }
            } else {
                throw new Error(data.error || 'Failed to get refinement');
            }
        } catch (error) {
            UIFeedback.show('error', 'Error: ' + error.message);
        } finally {
            UIFeedback.hideLoading();
        }
    }

    handleSendFeedback() {
        const feedback = this.feedbackInput.value.trim();
        const currentHypothesis = this.hypothesisContent.dataset.rawHypothesis;

        if (!feedback) {
            UIFeedback.show('error', 'Please enter feedback to refine the hypothesis.');
            return;
        }
        if (!currentHypothesis) {
            UIFeedback.show('error', 'No hypothesis to refine.');
            return;
        }

        this.fetchRefinement(currentHypothesis, feedback);
    }

    handleRefine() {
        const currentHypothesis = this.hypothesisContent.dataset.rawHypothesis;
        if (!currentHypothesis) {
            UIFeedback.show('error', 'No hypothesis to refine.');
            return;
        }
        this.fetchRefinement(currentHypothesis, null);
    }
}

document.addEventListener('DOMContentLoaded', () => {
    window.refinementManager = new RefinementManager();
});
{% endblock %}
