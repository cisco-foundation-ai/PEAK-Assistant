{% extends "base.html" %}

{% block title %}Hypothesis Refinement - PEAK Assistant{% endblock %}

{% set prev_phase_url = url_for('hypothesis_page') %}
{% set prev_phase_name = "Hypothesis Generation" %}
{% set next_phase_url = url_for('able_table_page') %}
{% set next_phase_name = "ABLE Table Generation" %}

{% block nav %}{{ super() }}{% endblock %}

{% block content %}
<div class="phase-container d-flex flex-column" style="height: calc(100vh - 80px);">
    <!-- Header -->
    <div class="phase-header">
        <h1 class="phase-title">Hypothesis Refinement</h1>
        <p class="phase-description mb-2">
            Review the current hypothesis. Provide feedback to the AI assistant to refine it.
        </p>
    </div>

    <!-- Main Content Area: Use flex-grow-1 to take up available space -->
    <div class="flex-grow-1" style="overflow-y: auto;">
        <!-- Hypothesis Display Area (always visible) -->
        <div id="hypothesis-container" class="content-card p-3 m-3">
            <div id="hypothesis-content" data-raw-hypothesis=""></div>
            <div id="no-hypothesis-placeholder" class="text-muted fst-italic" style="display: none;">
                No hypothesis available. Use the feedback area below to generate one.
            </div>
        </div>
    </div>

    <!-- Warning for Missing Hypothesis -->
    <div id="no-hypothesis-warning" class="prerequisite-warning p-4 rounded-3 m-3" style="display: none;">
        <h5 class="mb-1"><i class="bi bi-exclamation-triangle-fill me-2"></i>Missing Hypothesis</h5>
        <p class="mb-0">No hypothesis found. Please <a href="{{ url_for('hypothesis_page') }}" class="alert-link">create a hypothesis</a> first.</p>
    </div>

    <!-- Feedback Input Area: Stays at the bottom (always visible) -->
    <div id="feedback-container" class="action-section mt-auto p-3">
        <div class="input-group">
            <textarea id="feedback-input" class="form-control" rows="3" placeholder="Provide feedback to refine the hypothesis."></textarea>
            <button id="send-feedback-btn" class="btn btn-primary">
                <i class="bi bi-send me-2"></i>Send Feedback
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}

class RefinementManager {
    constructor() {

        this.hypothesisContent = document.getElementById('hypothesis-content');
        this.hypothesisContainer = document.getElementById('hypothesis-container');
        this.feedbackContainer = document.getElementById('feedback-container');
        this.noHypothesisWarning = document.getElementById('no-hypothesis-warning');
        this.feedbackInput = document.getElementById('feedback-input');

        this.setupEventListeners();
        this.loadInitialData();
    }

    setupEventListeners() {
        document.getElementById('send-feedback-btn').addEventListener('click', () => this.handleSendFeedback());
        this.feedbackInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.handleSendFeedback();
            }
        });
    }

    loadInitialData() {
        console.log('RefinementManager: loading initial data...');
        const hypothesis = sessionStorage.getItem('hypothesis');
        console.log('RefinementManager: hypothesis from sessionStorage:', hypothesis);
        this.displayHypothesis(hypothesis);
    }

    displayHypothesis(hypothesis) {
        console.log('RefinementManager: displayHypothesis called with:', hypothesis);
        const isHypothesisPresent = hypothesis && hypothesis.trim();
        console.log('RefinementManager: isHypothesisPresent:', isHypothesisPresent);
        const noHypothesisPlaceholder = document.getElementById('no-hypothesis-placeholder');

        if (isHypothesisPresent) {
            console.log('RefinementManager: displaying hypothesis.');
            this.noHypothesisWarning.style.display = 'none';
            this.hypothesisContent.style.display = 'block';
            noHypothesisPlaceholder.style.display = 'none';

            ContentRenderer.renderMarkdown(hypothesis, this.hypothesisContent);
            this.hypothesisContent.dataset.rawHypothesis = hypothesis;
            sessionStorage.setItem('hypothesis', hypothesis);
            this.feedbackInput.value = '';
        } else {
            console.log('RefinementManager: displaying placeholder.');
            this.noHypothesisWarning.style.display = 'none'; // Hide the warning
            this.hypothesisContent.style.display = 'none';
            noHypothesisPlaceholder.style.display = 'block';
        }
    }

    async handleSendFeedback() {
        const feedback = this.feedbackInput.value.trim();
        const previousHypothesis = this.hypothesisContent.dataset.rawHypothesis;

        if (!feedback) {
            UIFeedback.show('error', 'Please enter feedback to refine the hypothesis.');
            return;
        }

        if (!previousHypothesis) {
            UIFeedback.show('error', 'No hypothesis to refine. Please go back to the previous step.');
            return;
        }

        UIFeedback.show('loading', 'Refining hypothesis based on your feedback...');
        fetch('/api/refine', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                hypothesis: previousHypothesis, 
                feedback: feedback 
            }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                this.displayHypothesis(data.refined_hypothesis);
                UIFeedback.show('success', 'Hypothesis refined successfully.');
            } else {
                throw new Error(data.error || 'Refinement failed');
            }
        })
        .catch(error => {
            UIFeedback.show('error', 'Refinement Error: ' + error.message);
        })
        .finally(() => {
            UIFeedback.hideLoading();
        });
    }
}

document.addEventListener('DOMContentLoaded', () => {
    window.refinementManager = new RefinementManager();
});
{% endblock %}
