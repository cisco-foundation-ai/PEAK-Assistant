{% extends "base.html" %}

{% block title %}Hypothesis Refinement - PEAK Assistant{% endblock %}

{% set prev_phase_url = url_for('hypothesis_page') %}
{% set prev_phase_name = "Hypothesis Generation" %}
{% set next_phase_url = url_for('able_table_page') %}
{% set next_phase_name = "ABLE Table Generation" %}

{% block nav %}{{ super() }}{% endblock %}

{% block content %}
<div class="phase-container d-flex flex-column" style="height: calc(100vh - 80px);">
    <!-- Header -->
    <div class="phase-header d-flex justify-content-between align-items-center">
        <h1 class="phase-title mb-0">Hypothesis Refinement</h1>
        <button id="refine-btn" class="btn btn-primary">
            <i class="bi bi-robot me-2"></i>Refine Hypothesis
        </button>
    </div>

    <!-- Compact Phase Description -->
    <p class="phase-description">
        Review the current hypothesis. Provide feedback to the AI assistant to refine it.
    </p>

    <!-- Main Content Area: Use flex-grow-1 to take up available space -->
    <div class="flex-grow-1" style="overflow-y: auto;">
        <!-- Hypothesis Display Area (always visible) -->
        <!-- Current Hypothesis Display Area -->
        <div class="content-card p-3 m-3">
            <h5 class="text-muted">Current Hypothesis</h5>
            <div id="hypothesis-content" data-raw-hypothesis=""></div>
            <div id="no-hypothesis-placeholder" class="text-muted fst-italic" style="display: none;">
                No hypothesis available. Please generate one on the previous page.
            </div>
        </div>
    </div>

    <!-- Warning for Missing Hypothesis -->
    <div id="no-hypothesis-warning" class="prerequisite-warning p-4 rounded-3 m-3" style="display: none;">
        <h5 class="mb-1"><i class="bi bi-exclamation-triangle-fill me-2"></i>Missing Hypothesis</h5>
        <p class="mb-0">No hypothesis found. Please <a href="{{ url_for('hypothesis_page') }}" class="alert-link">create a hypothesis</a> first.</p>
    </div>

    <!-- Feedback Input Area: Stays at the bottom (always visible) -->
    <div id="feedback-container" class="action-section mt-auto p-3">
        <div class="input-group">
            <textarea id="feedback-input" class="form-control" rows="3" placeholder="Provide feedback to refine the hypothesis."></textarea>
            <button id="send-feedback-btn" class="btn btn-primary">
                <i class="bi bi-send me-2"></i>Send Feedback
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}

class RefinementManager {
    constructor() {
        this.hypothesisContent = document.getElementById('hypothesis-content');
        this.feedbackInput = document.getElementById('feedback-input');
        this.noHypothesisWarning = document.getElementById('no-hypothesis-warning');

        this.setupEventListeners();
        this.loadInitialData();
    }

    setupEventListeners() {
        document.getElementById('refine-btn').addEventListener('click', () => this.handleRefine());
        document.getElementById('send-feedback-btn').addEventListener('click', () => this.handleSendFeedback());
        this.feedbackInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.handleSendFeedback();
            }
        });
    }

    loadInitialData() {
        // Prioritize loading the refined hypothesis, fall back to the original
        const hypothesis = sessionStorage.getItem('refined_hypothesis') || sessionStorage.getItem('hypothesis');
        this.displayHypothesis(hypothesis);


    }

    displayHypothesis(hypothesis) {
        const isHypothesisPresent = hypothesis && hypothesis.trim();
        const noHypothesisPlaceholder = document.getElementById('no-hypothesis-placeholder');

        if (isHypothesisPresent) {
            this.noHypothesisWarning.style.display = 'none';
            this.hypothesisContent.style.display = 'block';
            noHypothesisPlaceholder.style.display = 'none';

            ContentRenderer.renderMarkdown(hypothesis, this.hypothesisContent);
            this.hypothesisContent.dataset.rawHypothesis = hypothesis;
            // Always save the latest version as the refined_hypothesis
            sessionStorage.setItem('refined_hypothesis', hypothesis);
        } else {
            this.noHypothesisWarning.style.display = 'none';
            this.hypothesisContent.style.display = 'none';
            noHypothesisPlaceholder.style.display = 'block';
        }
    }

    async fetchRefinement(hypothesis, feedback) {
        const endpoint = '/api/refine';
        const payload = { hypothesis, feedback };
        console.log('Sending to /api/refine:', payload);
        const loadingMessage = feedback ? 'Refining based on your feedback...' : 'Getting initial refinement...';

        UIFeedback.show('loading', loadingMessage);
        try {
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await response.json();
            if (data.success) {
                // Directly update the main hypothesis
                this.displayHypothesis(data.refined_hypothesis);
                if (feedback) {
                    this.feedbackInput.value = ''; // Clear feedback input on success
                }
            } else {
                throw new Error(data.error || 'Failed to get refinement');
            }
        } catch (error) {
            UIFeedback.show('error', 'Error: ' + error.message);
        } finally {
            UIFeedback.hideLoading();
        }
    }

    handleSendFeedback() {
        const feedback = this.feedbackInput.value.trim();
        const currentHypothesis = this.hypothesisContent.dataset.rawHypothesis;

        if (!feedback) {
            UIFeedback.show('error', 'Please enter feedback to refine the hypothesis.');
            return;
        }
        if (!currentHypothesis) {
            UIFeedback.show('error', 'No hypothesis to refine.');
            return;
        }

        this.fetchRefinement(currentHypothesis, feedback);
    }

    handleRefine() {
        const currentHypothesis = this.hypothesisContent.dataset.rawHypothesis;
        if (!currentHypothesis) {
            UIFeedback.show('error', 'No hypothesis to refine.');
            return;
        }
        this.fetchRefinement(currentHypothesis, null);
    }
}

document.addEventListener('DOMContentLoaded', () => {
    window.refinementManager = new RefinementManager();
});
{% endblock %}
