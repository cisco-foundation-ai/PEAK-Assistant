{% extends "base.html" %}

{% block title %}Hunt Plan - PEAK Assistant{% endblock %}

{% block nav %}
    {% set prev_phase_url = url_for('data_discovery_page') %}
    {% set prev_phase_name = "Data Discovery" %}
    {% set next_phase_url = None %}
    {% set next_phase_name = None %}
    {{ super() }}
{% endblock %}

{% block content %}
<div class="phase-container">
    <!-- Compact Phase Header -->
    <div class="phase-header">
        <h1 class="phase-title">Generate Hunt Plan</h1>
        <div id="download-plan-actions-container" style="display: none;">
            <!-- Download button will be inserted here by script -->
        </div>
    </div>
    
    <!-- Compact Phase Description -->
    <p class="phase-description">
        Use AI agents to combine your research, hypothesis, ABLE table, and data sources into a comprehensive hunt plan.
    </p>

    <!-- Prerequisite Warning -->
    <div id="missing-prerequisites-warning" class="prerequisite-warning" style="display: none;">
        <h5><i class="bi bi-exclamation-triangle-fill me-2"></i>Missing Prerequisites</h5>
        <p class="mb-1">Complete the following phases first:</p>
        <ul id="missing-items-list" class="prerequisite-list"></ul>
    </div>

    <!-- Compact Action Section -->
    <div class="action-section">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <div class="action-section-title">
                    <i class="bi bi-robot me-2"></i>AI Hunt Plan Generation
                </div>
                <small class="text-muted">AI agents will analyze all your previous work to create a comprehensive hunting plan.</small>
            </div>
            <button id="generate-hunt-plan-btn" class="btn btn-primary">
                <i class="bi bi-magic me-2"></i>Generate Hunt Plan
            </button>
        </div>
    </div>

    <!-- Content Display - Takes up most of the page -->
    <div id="hunt-plan-container" style="display: none;">
        <div class="content-card">
            <div id="plan-content" data-raw-markdown=""></div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
/**
 * Hunt Planning Phase Manager
 */
class HuntPlanningManager extends PhaseManager {
    constructor() {
        super('hunt_plan', {
            apiEndpoint: '/api/hunt-plan',
            contentContainer: 'plan-content',
            downloadContainer: 'download-plan-actions-container',
            sessionStorageKey: 'hunt_plan',
            globalContentVar: 'currentPlanMarkdown',
            responseContentKey: 'hunt_plan',
            loadingMessage: 'AI agents are creating your comprehensive hunt plan... (this may take several minutes)',
            generateButtonTitle: 'Generate comprehensive hunt plan using AI agents',
            generateButtonText: '<i class="bi bi-magic me-2"></i>Generate AI Hunt Plan',
            prerequisites: [
                {
                    sessionKey: 'report_md',
                    name: 'Research Document',
                    url: '/research'
                },
                {
                    sessionKey: 'hypothesis',
                    name: 'Hypothesis',
                    url: '/hypothesis'
                },
                {
                    sessionKey: 'able_table_md',
                    name: 'ABLE Table',
                    url: '/able-table'
                },
                {
                    sessionKey: 'data_sources_md',
                    name: 'Data Discovery',
                    url: '/data-discovery'
                }
            ]
        });
    }
    
    setupEventListeners() {
        const generateBtn = document.getElementById('generate-hunt-plan-btn');
        if (generateBtn) {
            generateBtn.addEventListener('click', () => this.handleGenerate());
        }
    }
    
    async handleGenerate() {
        // Check if prerequisites are met before proceeding
        const prereqCheck = await this.checkPrerequisites();
        if (!prereqCheck.valid) {
            UIFeedback.show('error', 'Please complete all prerequisite phases first.');
            return;
        }
        
        try {
            await this.generateContent();
            
            // Update hunt planning prerequisites check in the sidebar
            if (typeof checkHuntPlanningPrerequisites === 'function') {
                checkHuntPlanningPrerequisites();
            }
        } catch (error) {
            // Error handling is already done in the parent class
        }
    }
    
    async checkPrerequisites() {
        try {
            const sessionData = await this.apiClient.getSessionData();
            const missing = [];
            
            // Check for research document
            if (!sessionData.report_md || !sessionData.report_md.trim()) {
                missing.push({
                    sessionKey: 'report_md',
                    name: 'Research Document',
                    url: '/research'
                });
            }
            
            // Check for hypothesis (refined or original)
            if (!sessionData.refined_hypothesis && !sessionData.hypothesis) {
                missing.push({
                    sessionKey: 'hypothesis',
                    name: 'Hypothesis',
                    url: '/hypothesis'
                });
            }
            
            // Check for ABLE table
            if (!sessionData.able_table_md) {
                missing.push({
                    sessionKey: 'able_table_md',
                    name: 'ABLE Table',
                    url: '/able-table'
                });
            }
            
            // Check for data discovery
            if (!sessionData.data_sources_md) {
                missing.push({
                    sessionKey: 'data_sources_md',
                    name: 'Data Discovery',
                    url: '/data-discovery'
                });
            }
            
            this.updatePrerequisiteUI(missing);
            return { valid: missing.length === 0, missing };
        } catch (error) {
            console.warn('Could not check prerequisites:', error);
            return { valid: true, missing: [] };
        }
    }
    
    updatePrerequisiteUI(missingPrereqs) {
        const warningElement = document.getElementById('missing-prerequisites-warning');
        const generateBtn = document.getElementById('generate-hunt-plan-btn');
        
        if (missingPrereqs.length > 0 && warningElement) {
            const itemsList = document.getElementById('missing-items-list');
            if (itemsList) {
                itemsList.innerHTML = missingPrereqs.map(prereq => 
                    `<li><a href="${prereq.url}">${prereq.name}</a></li>`
                ).join('');
            }
            warningElement.style.display = 'block';
            
            if (generateBtn) {
                generateBtn.disabled = true;
                generateBtn.classList.add('btn-disabled-warning');
                generateBtn.title = 'Complete all prerequisite phases first';
                generateBtn.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>Prerequisites Required';
            }
        } else {
            if (warningElement) {
                warningElement.style.display = 'none';
            }
            
            if (generateBtn) {
                generateBtn.disabled = false;
                generateBtn.classList.remove('btn-disabled-warning');
                generateBtn.title = 'Generate comprehensive hunt plan using AI agents';
                generateBtn.innerHTML = '<i class="bi bi-magic me-2"></i>Generate AI Hunt Plan';
            }
        }
    }
    
    onContentGenerated(response) {
        // Show content container
        const huntPlanContainer = document.getElementById('hunt-plan-container');
        if (huntPlanContainer) {
            huntPlanContainer.style.display = 'block';
        }
        
        // Setup download button
        DownloadManager.setupDownloadButton(
            this.config.contentContainer,
            'hunt_plan',
            this.config.downloadContainer
        );
        
        // Show download container
        const downloadContainer = document.getElementById(this.config.downloadContainer);
        if (downloadContainer) {
            downloadContainer.style.display = 'flex';
        }
    }
}

// Initialize the Hunt Planning Manager when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    window.huntPlanningManager = new HuntPlanningManager();
});
{% endblock %}
