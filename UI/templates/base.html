<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}PEAK Assistant UI{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* ==========================================================================
           COMPACT DESIGN SYSTEM - CSS Variables for efficient space usage
           ========================================================================== */
        :root {
            --primary-color: #0d6efd;
            --secondary-color: #6c757d;
            --success-color: #198754;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #0dcaf0;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            
            --border-color: #dee2e6;
            --border-radius: 0.375rem;
            --border-radius-sm: 0.25rem;
            --border-radius-lg: 0.5rem;
            
            /* Compact spacing system */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 0.75rem;
            --spacing-lg: 1rem;
            --spacing-xl: 1.25rem;
            --spacing-xxl: 1.5rem;
            
            /* Compact typography */
            --font-size-xs: 0.75rem;
            --font-size-sm: 0.875rem;
            --font-size-base: 0.9rem;
            --font-size-lg: 1rem;
            --font-size-xl: 1.125rem;
            --font-size-xxl: 1.25rem;
            
            --shadow-sm: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            --shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            
            --transition: all 0.15s ease-in-out;
        }

        /* ==========================================================================
           COMPACT LAYOUT COMPONENTS
           ========================================================================== */
        .sidebar {
            min-height: 100vh;
            background-color: var(--light-color);
            border-right: 1px solid var(--border-color);
            padding: var(--spacing-lg);
        }
        
        .content {
            padding: var(--spacing-lg) var(--spacing-xl);
        }

        /* ==========================================================================
           COMPACT PHASE CONTAINER SYSTEM
           ========================================================================== */
        .phase-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .phase-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-sm);
            border-bottom: 1px solid var(--border-color);
        }
        
        .phase-title {
            font-size: var(--font-size-xl);
            font-weight: 600;
            color: var(--dark-color);
            margin: 0;
        }
        
        .phase-description {
            color: var(--secondary-color);
            margin-bottom: var(--spacing-lg);
            font-size: var(--font-size-sm);
            line-height: 1.4;
        }

        /* ==========================================================================
           COMPACT CONTENT CARDS
           ========================================================================== */
        .content-card {
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            background: #ffffff;
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            min-height: 300px;
        }
        
        .content-card:hover {
            box-shadow: var(--shadow);
        }
        
        .content-card.empty {
            background: var(--light-color);
            border-style: dashed;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--secondary-color);
            font-style: italic;
            min-height: 200px;
        }

        /* Content Preview Cards - for displaying hypothesis on other pages */
        .content-preview-card {
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background: #ffffff;
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--spacing-md);
        }
        
        .content-preview-header {
            padding: var(--spacing-sm) var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
            background: var(--light-color);
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }
        
        .content-preview-header h5 {
            margin: 0;
            font-size: var(--font-size-sm);
            font-weight: 600;
            color: var(--dark-color);
        }
        
        .content-preview-body {
            padding: var(--spacing-md);
            max-height: 150px;
            overflow-y: auto;
            font-size: var(--font-size-sm);
            line-height: 1.4;
        }

        /* ==========================================================================
           COMPACT ACTION SECTIONS
           ========================================================================== */
        .action-buttons {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
            flex-wrap: wrap;
        }
        
        .action-section {
            background: var(--light-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }
        
        .action-section-title {
            font-size: var(--font-size-base);
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
            color: var(--dark-color);
        }

        /* ==========================================================================
           COMPACT FORM COMPONENTS
           ========================================================================== */
        .form-section {
            background: #ffffff;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }
        
        .input-group-enhanced {
            display: flex;
            gap: var(--spacing-sm);
            align-items: end;
        }
        
        .input-group-enhanced .form-control {
            flex: 1;
        }

        /* ==========================================================================
           COMPACT BUTTON ENHANCEMENTS
           ========================================================================== */
        .btn {
            border-radius: var(--border-radius-sm);
            font-weight: 500;
            transition: var(--transition);
            border-width: 1px;
            font-size: var(--font-size-sm);
            padding: var(--spacing-sm) var(--spacing-md);
        }
        
        .btn-lg {
            font-size: var(--font-size-base);
            padding: var(--spacing-sm) var(--spacing-lg);
        }
        
        .btn:focus {
            box-shadow: 0 0 0 0.2rem rgba(var(--primary-color), 0.25);
        }
        
        .btn-disabled-warning {
            opacity: 0.6;
            cursor: not-allowed !important;
        }
        
        .btn-disabled-warning:hover {
            opacity: 0.6 !important;
        }

        /* ==========================================================================
           COMPACT PREREQUISITE SYSTEM
           ========================================================================== */
        .prerequisite-warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 1px solid var(--warning-color);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }
        
        .prerequisite-warning h5 {
            color: #856404;
            margin-bottom: var(--spacing-sm);
            font-size: var(--font-size-base);
        }
        
        .prerequisite-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .prerequisite-list li {
            padding: var(--spacing-xs) 0;
            border-bottom: 1px solid rgba(133, 100, 4, 0.2);
            font-size: var(--font-size-sm);
        }
        
        .prerequisite-list li:last-child {
            border-bottom: none;
        }
        
        .prerequisite-list a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }
        
        .prerequisite-list a:hover {
            text-decoration: underline;
        }

        /* ==========================================================================
           SIDEBAR NAVIGATION
           ========================================================================== */
        .sidebar-title-link {
            font-size: 1.75rem;
            font-weight: 500;
            color: var(--dark-color);
            text-decoration: none;
            transition: var(--transition);
        }
        
        .sidebar-title-link:hover {
            color: var(--primary-color);
            text-decoration: none;
        }
        
        .sidebar-logo {
            width: 100%;
            height: auto;
            vertical-align: middle;
        }

        /* ==========================================================================
           COMPACT TOP NAVIGATION
           ========================================================================== */
        .top-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-sm) 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: var(--spacing-md);
        }
        
        .top-navigation .nav-arrow {
            font-size: 1.25rem;
        }
        
        .top-navigation .nav-text {
            font-size: var(--font-size-xs);
            color: var(--secondary-color);
        }
        
        .top-navigation .btn-outline-secondary:hover {
            background-color: #adb5bd !important;
            border-color: #adb5bd !important;
            color: var(--dark-color) !important;
        }
        
        .top-navigation .btn-outline-primary:hover {
            background-color: #b6d7ff !important;
            border-color: #b6d7ff !important;
            color: #0a58ca !important;
        }

        /* ==========================================================================
           LOADING AND FEEDBACK COMPONENTS
           ========================================================================== */
        #loading-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1060;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: var(--spacing-xl);
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: var(--shadow-lg);
        }
        
        .spinner-border {
            width: 2rem;
            height: 2rem;
        }

        /* ==========================================================================
           TOASTS AND NOTIFICATIONS
           ========================================================================== */
        #error-message {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1050;
        }
        
        #success-toast-container {
            position: fixed;
            top: 70px;
            right: 10px;
            z-index: 1050;
        }

        /* ==========================================================================
           HELP ICON
           ========================================================================== */
        .help-icon {
            position: fixed;
            bottom: var(--spacing-xl);
            right: var(--spacing-xl);
            z-index: 1000;
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            text-decoration: none;
            transition: var(--transition);
        }
        
        .help-icon:hover {
            background-color: #0b5ed7;
            transform: scale(1.05);
        }
        
        .help-icon svg {
            width: 24px;
            height: 24px;
        }

        /* ==========================================================================
           COMPACT UTILITY CLASSES
           ========================================================================== */
        .debug-section {
            border-top: 1px solid var(--border-color);
            margin-top: var(--spacing-lg);
        }
        
        pre {
            background-color: var(--light-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            padding: var(--spacing-sm);
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: var(--font-size-xs);
            line-height: 1.3;
        }
        
        .btn-hunt-planning-disabled-color {
            background-color: #146c43 !important;
            border-color: #13653f !important;
        }

        /* Compact form controls */
        .form-control-sm, .form-select-sm {
            font-size: var(--font-size-sm);
        }
        
        /* Compact alerts */
        .alert {
            padding: var(--spacing-sm) var(--spacing-md);
        }
        
        .alert.py-1 {
            padding-top: var(--spacing-xs) !important;
            padding-bottom: var(--spacing-xs) !important;
        }
        
        /* Better space utilization */
        .g-3 > .col-md-6,
        .g-3 > .col-md-4,
        .g-3 > .col-md-8 {
            margin-bottom: var(--spacing-sm);
        }

        /* ==========================================================================
           RESPONSIVE DESIGN - More aggressive space saving on mobile
           ========================================================================== */
        @media (max-width: 768px) {
            .content {
                padding: var(--spacing-sm);
            }
            
            .phase-header {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--spacing-sm);
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .input-group-enhanced {
                flex-direction: column;
                align-items: stretch;
            }
            
            .btn-lg {
                font-size: var(--font-size-sm);
                padding: var(--spacing-sm) var(--spacing-md);
            }
            
            .content-card {
                padding: var(--spacing-sm);
                min-height: 200px;
            }
        }

        @media (max-width: 576px) {
            .phase-container {
                padding: 0 var(--spacing-xs);
            }
            
            .action-section {
                padding: var(--spacing-sm);
            }
            
            .content-card {
                min-height: 150px;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse" id="sidebarMenu">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item mb-2"> <!-- Added margin-bottom for spacing -->
                            <a class="nav-link active sidebar-title-link w-100" aria-current="page" href="/">
                                <img src="{{ url_for('static', filename='images/peak-logo.png') }}" alt="PEAK Assistant Logo" class="sidebar-logo">
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/research">
                                Topic Research
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/hypothesis">
                                Hypothesis Generation
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/refinement">
                                Hypothesis Refinement
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/able-table">
                                ABLE Table
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/data-discovery">
                                Data Discovery
                            </a>
                        </li>
                        <li class="nav-item">
                            <a id="hunt-planning-btn" class="nav-link btn btn-success text-white mt-1 mb-1 w-100" href="/hunt-planning">
                                Generate Hunt Plan
                            </a>
                        </li>
                        <li class="nav-item mt-2"> <!-- Removed px-3 -->
                            <button id="clear-session-sidebar-btn" class="btn btn-danger w-100" style="padding-top: 0.5rem; padding-bottom: 0.5rem;">Clear Everything and Start Over</button>
                        </li>
                    </ul>

                    <div class="debug-section pt-3 mt-auto">
                        <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                            <span>Tools</span>
                        </h6>
                        <ul class="nav flex-column mb-2">
                            <li class="nav-item">
                                <a class="nav-link" href="/help">
                                    Help
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="/debug">
                                    Debug
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 content">
                {% block nav %}
                <div class="top-navigation">
                    <div>
                        {% if prev_phase_url %}
                            <a href="{{ prev_phase_url }}" class="btn btn-outline-secondary">
                                <span class="nav-arrow">&larr;</span> <span class="nav-text">{{ prev_phase_name }}</span>
                            </a>
                        {% else %}
                            <span>&nbsp;</span> <!-- Placeholder to keep alignment -->
                        {% endif %}
                    </div>
                    <div>
                        {% if next_phase_url %}
                            <a href="{{ next_phase_url }}" class="btn btn-outline-primary">
                                <span class="nav-text">{{ next_phase_name }}</span> <span class="nav-arrow">&rarr;</span>
                            </a>
                        {% else %}
                            <span>&nbsp;</span> <!-- Placeholder to keep alignment -->
                        {% endif %}
                    </div>
                </div>
                {% endblock %}

                {% block content %}{% endblock %}

                <!-- Debug Panel (hidden by default) -->
                <div id="debug-panel" class="mt-5 p-3 border bg-light" style="display: none;">
                    <h4>Verbose Output / Logs</h4>
                    <pre id="debug-output">Verbose output will appear here...</pre>
                </div>
            </main>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loading-indicator" style="display: none;">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p id="loading-message" class="mt-2">Processing...</p>
    </div>

    <!-- Error Message Toast -->
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 1050">
        <div id="error-toast" class="toast hide" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-danger text-white">
                <strong class="me-auto">Error</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                <span id="error-message-text"></span>
                <button id="show-error-details" class="btn btn-sm btn-link p-0" style="display:none;">Show Details</button>
                <pre id="error-details-content" class="mt-2" style="display:none; max-height: 200px; overflow-y: auto;"></pre>
            </div>
        </div>
    </div>

    <!-- Success Toast -->
    <div id="success-toast-container" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="5000">
        <div class="d-flex">
            <div class="toast-body" id="success-toast-body">
                <!-- Success message will be inserted here -->
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
    
    <!-- Help Floating Button -->
    <a href="/help" class="help-icon" title="Help">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-question-lg" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M4.475 5.458c-.284 0-.514.237-.47.517C4.28 7.94 5.765 9.85 8 9.85c2.235 0 3.72-1.91 3.995-3.875.044-.28-.186-.517-.47-.517H4.475zM8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zM6.572 4.004c.04-.28.21-.505.478-.505h.9c.266 0 .438.225.478.505.078.54.45 1.328 1.258 2.142.807.814 1.64.935 1.64 1.536 0 .672-.724 1.423-1.825 1.423-1.212 0-1.77-.874-1.77-1.423 0-.394.117-.724.303-.975.187-.25.49-.583.49-.967 0-.386-.254-.687-.572-.937-.318-.25-.776-.592-1.15-.937C6.022 5.332 5.5 4.54 5.5 3.652c0-.28.21-.505.478-.505h.116c.266 0 .438.225.478.505.04.28.028.47-.003.586a.87.87 0 0 0-.08.29c-.06.226-.08.43-.08.61 0 .29.087.52.236.708.15.187.386.363.703.625.318.26.703.592.988.937.286.346.443.746.443 1.187 0 .672-.587 1.423-1.425 1.423S6.25 11.187 6.25 10.515c0-.76.725-1.691 1.8-2.036.23-.075.405-.165.53-.27.124-.104.187-.226.187-.363 0-.24-.164-.43-.405-.566-.24-.137-.56-.237-.96-.237-.353 0-.655.06-.89.18S4.87 7.17 4.87 7.416c0 .28-.21.505-.478.505H4.3c-.267 0-.438-.225-.478-.505C3.744 6.215 4.87 4.004 6.572 4.004z"/>
        </svg>
    </a>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        /* ==========================================================================
           MODERN UI ARCHITECTURE - Core Components and API Client
           ========================================================================== */
        
        /**
         * Centralized API Client for all backend communication
         */
        class APIClient {
            constructor() {
                this.baseURL = '';
                this.defaultRetryCount = 3;
                this.defaultTimeout = 300000; // 5 minutes
            }
            
            getRetryCount() {
                const stored = localStorage.getItem('retryCount') || localStorage.getItem('retry-count-page');
                return stored ? parseInt(stored, 10) || this.defaultRetryCount : this.defaultRetryCount;
            }
            
            getVerboseMode() {
                return localStorage.getItem('verboseMode') === 'true' || 
                       localStorage.getItem('debug-mode-page') === 'true';
            }
            
            async delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
            
            async callWithRetry(endpoint, data = {}, options = {}) {
                const retryCount = options.retryCount || this.getRetryCount();
                const verboseMode = options.verboseMode !== undefined ? options.verboseMode : this.getVerboseMode();
                
                const requestData = {
                    ...data,
                    retry_count: retryCount,
                    verbose_mode: verboseMode
                };
                
                for (let attempt = 1; attempt <= retryCount; attempt++) {
                    try {
                        const response = await fetch(endpoint, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(requestData)
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            throw new Error(errorData.error || `HTTP ${response.status}`);
                        }
                        
                        return await response.json();
                    } catch (error) {
                        if (attempt === retryCount) {
                            throw error;
                        }
                        await this.delay(1000 * attempt); // Exponential backoff
                    }
                }
            }
            
            async uploadFile(endpoint, formData) {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }
                
                return await response.json();
            }
            
            async getSessionData() {
                try {
                    const response = await fetch('/api/debug-info');
                    const data = await response.json();
                    return data.session_data || {};
                } catch (error) {
                    console.warn('Could not fetch session data:', error);
                    return {};
                }
            }
        }
        
        /**
         * Centralized UI feedback management
         */
        class UIFeedback {
            static show(type, message, detail = null, duration = null) {
                switch (type) {
                    case 'loading':
                        this.showLoading(message);
                        break;
                    case 'success':
                        this.showSuccess(message, duration);
                        break;
                    case 'error':
                        this.showError(message, detail);
                        break;
                }
            }
            
            static showLoading(message = "Processing...") {
                document.getElementById('loading-message').textContent = message;
                document.getElementById('loading-indicator').style.display = 'flex';
            }
            
            static hideLoading() {
                document.getElementById('loading-indicator').style.display = 'none';
            }
            
            static showError(message, detail = null) {
                const errorToastEl = document.getElementById('error-toast');
                const toast = new bootstrap.Toast(errorToastEl);
                document.getElementById('error-message-text').textContent = message;

                const detailsBtn = document.getElementById('show-error-details');
                const detailsContent = document.getElementById('error-details-content');

                if (detail) {
                    detailsContent.textContent = typeof detail === 'object' ? JSON.stringify(detail, null, 2) : detail;
                    detailsBtn.style.display = 'inline';
                    detailsContent.style.display = 'none'; 
                } else {
                    detailsBtn.style.display = 'none';
                    detailsContent.style.display = 'none';
                }
                toast.show();
            }
            
            static hideError() {
                const errorToastEl = document.getElementById('error-toast');
                const toast = bootstrap.Toast.getInstance(errorToastEl);
                if (toast) {
                    toast.hide();
                }
                document.getElementById('error-details-content').style.display = 'none';
                document.getElementById('show-error-details').style.display = 'none';
            }

            static showSuccess(message, duration = 5000) {
                const successToastEl = document.getElementById('success-toast-container');
                // Ensure delay is always a valid number, default to 5000ms if invalid
                const delay = (typeof duration === 'number' && duration > 0) ? duration : 5000;
                const toast = bootstrap.Toast.getOrCreateInstance(successToastEl, { delay: delay });
                document.getElementById('success-toast-body').textContent = message;
                toast.show();
            }
        }
        
        /**
         * Content renderer with markdown support
         */
        class ContentRenderer {
            static renderMarkdown(markdown, targetElement) {
                if (typeof markdown === 'string' && markdown.trim()) {
                    try {
                        if (typeof marked !== 'undefined' && marked.parse) {
                            console.log('ContentRenderer: About to render markdown, length:', markdown.length);
                            console.log('ContentRenderer: First 200 chars:', markdown.substring(0, 200));
                            
                            // Check for code blocks in the markdown
                            const codeBlockMatches = markdown.match(/```[\s\S]*?```/g);
                            if (codeBlockMatches) {
                                console.log('ContentRenderer: Found', codeBlockMatches.length, 'code blocks');
                                console.log('ContentRenderer: First code block:', codeBlockMatches[0].substring(0, 100));
                            }
                            
                            // Configure marked options for better code block handling
                            if (typeof marked.setOptions === 'function') {
                                marked.setOptions({
                                    breaks: true,
                                    gfm: true,
                                    sanitize: false
                                });
                            }
                            
                            const renderedHTML = marked.parse(markdown);
                            console.log('ContentRenderer: Rendered HTML length:', renderedHTML.length);
                            console.log('ContentRenderer: First 200 chars of HTML:', renderedHTML.substring(0, 200));
                            
                            // Clear target element completely before setting new content
                            targetElement.innerHTML = '';
                            targetElement.innerHTML = renderedHTML;
                            targetElement.classList.remove('empty');
                            console.log('ContentRenderer: Successfully rendered markdown');
                        } else {
                            console.warn('ContentRenderer: marked library not available, showing raw markdown');
                            targetElement.innerHTML = '<pre>' + markdown + '</pre>';
                            targetElement.classList.remove('empty');
                        }
                    } catch (error) {
                        console.error('ContentRenderer: Error rendering markdown:', error);
                        console.log('ContentRenderer: Error occurred with markdown:', markdown.substring(0, 500));
                        targetElement.innerHTML = '<div class="alert alert-warning">Error rendering content. Showing raw markdown:</div><pre>' + markdown + '</pre>';
                        targetElement.classList.remove('empty');
                    }
                } else {
                    targetElement.innerHTML = '<p class="text-muted"><em>Content will appear here...</em></p>';
                    targetElement.classList.add('empty');
                    console.warn("Invalid content for Markdown rendering:", markdown);
                }
            }
            
            static clearContent(targetElement) {
                targetElement.innerHTML = '<p class="text-muted"><em>Content will appear here...</em></p>';
                targetElement.classList.add('empty');
                targetElement.dataset.rawMarkdown = '';
            }
        }
        
        /**
         * Unified download manager
         */
        class DownloadManager {
            static setupDownloadButton(targetContentId, baseFilename, containerId) {
                const container = document.getElementById(containerId);
                if (!container) {
                    console.error('Download button container not found:', containerId);
                    return;
                }

                container.innerHTML = `
                    <div class="btn-group">
                        <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-download me-1"></i> Download
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" data-format="markdown">
                                <i class="bi bi-file-earmark-text me-2"></i>Download Markdown (.md)
                            </a></li>
                            <li><a class="dropdown-item" href="#" data-format="pdf">
                                <i class="bi bi-file-earmark-pdf me-2"></i>Download PDF (.pdf)
                            </a></li>
                        </ul>
                    </div>
                `;

                container.querySelectorAll('.dropdown-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.handleDownload(targetContentId, baseFilename, item.dataset.format);
                    });
                });
            }
            
            static async handleDownload(targetContentId, baseFilename, format) {
                const contentElement = document.getElementById(targetContentId);
                let contentToDownload = '';

                if (contentElement) {
                    contentToDownload = contentElement.dataset.rawMarkdown || contentElement.innerText || contentElement.value;
                } else {
                    // Fallback for global content variables
                    contentToDownload = this.getGlobalContent(targetContentId);
                }
                
                if (!contentToDownload) {
                    UIFeedback.show('error', `No content available to download as ${format.toUpperCase()}. Please generate content first.`);
                    return;
                }

                const filename = `${baseFilename}.${format === 'markdown' ? 'md' : 'pdf'}`;
                const apiUrl = format === 'markdown' ? '/api/download/markdown' : '/api/download/pdf';

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ content: contentToDownload, filename: filename })
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'Download failed');
                    }
                    
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                } catch (error) {
                    UIFeedback.show('error', 'Download error: ' + error.message, error.detail || error);
                }
            }
            
            static getGlobalContent(targetContentId) {
                // Map target content IDs to global variables
                const contentMap = {
                    'plan-content': 'currentPlanMarkdown',
                    'report-content': 'currentReportMarkdown',
                    'current-hypo-content': 'currentHypothesisMarkdown',
                    'refined-hypo-content': 'currentRefinedHypothesisMarkdown',
                    'able-table-content': 'currentAbleTableMarkdown',
                    'data-sources-content': 'currentDataSourcesMarkdown'
                };
                
                const globalVar = contentMap[targetContentId];
                return globalVar && window[globalVar] ? window[globalVar] : '';
            }
        }
        
        /**
         * Standardized Phase Manager for consistent workflow handling
         */
        class PhaseManager {
            constructor(phaseId, config = {}) {
                this.phaseId = phaseId;
                this.config = {
                    apiEndpoint: config.apiEndpoint,
                    contentContainer: config.contentContainer,
                    downloadContainer: config.downloadContainer,
                    prerequisites: config.prerequisites || [],
                    sessionStorageKey: config.sessionStorageKey,
                    globalContentVar: config.globalContentVar,
                    ...config
                };
                
                this.apiClient = new APIClient();
                this.setupEventListeners();
                this.loadInitialData();
                this.checkPrerequisites();
            }
            
            setupEventListeners() {
                // Override in subclasses
            }
            
            async loadInitialData() {
                console.log(`[${this.phaseId}] 1. Starting loadInitialData.`);
                const stored = sessionStorage.getItem(this.config.sessionStorageKey);
                console.log(`[${this.phaseId}] 2. Checked sessionStorage for key '${this.config.sessionStorageKey}'. Found content length: ${stored ? stored.length : 'null'}`);

                if (stored && stored.trim()) {
                    console.log(`[${this.phaseId}] 3a. Found data in sessionStorage. Displaying it.`);
                    this.displayContent(stored);
                } else {
                    console.log(`[${this.phaseId}] 3b. No data in sessionStorage. Falling back to server.`);
                    // Fallback to server session
                    try {
                        const sessionData = await this.apiClient.getSessionData();
                        console.log(`[${this.phaseId}] 4. Fetched session data from server:`, sessionData);
                        const content = sessionData[this.config.sessionStorageKey];
                        console.log(`[${this.phaseId}] 5. Extracted content for key '${this.config.sessionStorageKey}'. Found content length: ${content ? content.length : 'null'}`);

                        if (content && content.trim()) {
                            console.log(`[${this.phaseId}] 6a. Found data on server. Displaying it and setting sessionStorage.`);
                            this.displayContent(content);
                            sessionStorage.setItem(this.config.sessionStorageKey, content);
                        } else {
                            console.log(`[${this.phaseId}] 6b. No data found on server for this key.`);
                        }
                    } catch (error) {
                        console.warn(`[${this.phaseId}] Error loading initial data from server:`, error);
                    }
                }
                
                // Setup download button
                if (this.config.downloadContainer) {
                    DownloadManager.setupDownloadButton(
                        this.config.contentContainer,
                        this.phaseId,
                        this.config.downloadContainer
                    );
                }
            }
            
            displayContent(content) {
                const contentElement = document.getElementById(this.config.contentContainer);
                const downloadContainer = document.getElementById(this.config.downloadContainer);
                
                if (content && content.trim()) {
                    if (this.config.globalContentVar) {
                        window[this.config.globalContentVar] = content;
                    }
                    contentElement.dataset.rawMarkdown = content;
                    ContentRenderer.renderMarkdown(content, contentElement);
                    
                    if (downloadContainer) {
                        downloadContainer.style.display = 'flex';
                    }
                } else {
                    ContentRenderer.clearContent(contentElement);
                    if (downloadContainer) {
                        downloadContainer.style.display = 'none';
                    }
                }
            }
            
            clearContent() {
                const contentElement = document.getElementById(this.config.contentContainer);
                const downloadContainer = document.getElementById(this.config.downloadContainer);
                
                ContentRenderer.clearContent(contentElement);
                if (downloadContainer) {
                    downloadContainer.style.display = 'none';
                }
                
                if (this.config.sessionStorageKey) {
                    sessionStorage.removeItem(this.config.sessionStorageKey);
                }
                
                if (this.config.globalContentVar) {
                    window[this.config.globalContentVar] = '';
                }
            }
            
            async generateContent(requestBody = {}) {
                if (!this.config.apiEndpoint) {
                    throw new Error('API endpoint not configured');
                }
                
                this.clearContent();
                UIFeedback.hideError();
                UIFeedback.show('loading', this.config.loadingMessage || 'Generating content...');
                
                try {
                    const response = await this.apiClient.callWithRetry(this.config.apiEndpoint, requestBody);
                    if (response.success) {
                        const content = response[this.config.responseContentKey] || response.content;
                        this.displayContent(content);
                        
                        if (this.config.sessionStorageKey) {
                            sessionStorage.setItem(this.config.sessionStorageKey, content);
                        }
                        
                        if (this.onContentGenerated) {
                            this.onContentGenerated(response);
                        }
                        return response;
                    } else {
                        throw new Error(response.error || 'Generation failed');
                    }
                } catch (error) {
                    UIFeedback.show('error', 'Error generating content: ' + error.message);
                    throw error;
                } finally {
                    UIFeedback.hideLoading();
                }
            }
            
            onContentGenerated(response) {
                // Override in subclasses for custom post-generation logic
            }
            
            async checkPrerequisites() {
                if (!this.config.prerequisites || this.config.prerequisites.length === 0) {
                    return { valid: true, missing: [] };
                }
                
                try {
                    const sessionData = await this.apiClient.getSessionData();
                    const missing = [];
                    
                    for (const prereq of this.config.prerequisites) {
                        const hasContent = sessionData[prereq.sessionKey] && sessionData[prereq.sessionKey].trim();
                        if (!hasContent) {
                            missing.push(prereq);
                        }
                    }
                    
                    this.updatePrerequisiteUI(missing);
                    return { valid: missing.length === 0, missing };
                } catch (error) {
                    console.warn('Could not check prerequisites:', error);
                    return { valid: true, missing: [] };
                }
            }
            
            updatePrerequisiteUI(missingPrereqs) {
                const warningElement = document.getElementById('missing-prerequisites-warning');
                const generateBtn = document.getElementById('generate-btn') || document.getElementById(`generate-${this.phaseId}-btn`);
                
                if (missingPrereqs.length > 0 && warningElement) {
                    const itemsList = document.getElementById('missing-items-list');
                    if (itemsList) {
                        itemsList.innerHTML = missingPrereqs.map(prereq => 
                            `<li><a href="${prereq.url}">${prereq.name}</a></li>`
                        ).join('');
                    }
                    warningElement.style.display = 'block';
                    
                    if (generateBtn) {
                        generateBtn.disabled = true;
                        generateBtn.classList.add('btn-disabled-warning');
                        generateBtn.title = 'Complete all prerequisite phases first';
                        generateBtn.innerHTML = 'âš  Prerequisites Required';
                    }
                } else {
                    if (warningElement) {
                        warningElement.style.display = 'none';
                    }
                    
                    if (generateBtn) {
                        generateBtn.disabled = false;
                        generateBtn.classList.remove('btn-disabled-warning');
                        generateBtn.title = this.config.generateButtonTitle || 'Generate content';
                        generateBtn.innerHTML = this.config.generateButtonText || 'Generate';
                    }
                }
            }
        }
        
        // Initialize global instances
        window.apiClient = new APIClient();
        window.UIFeedback = UIFeedback;
        window.ContentRenderer = ContentRenderer;
        window.DownloadManager = DownloadManager;
        window.PhaseManager = PhaseManager;
        
        // Legacy function aliases for backward compatibility
        function showLoading(message) { UIFeedback.showLoading(message); }
        function hideLoading() { UIFeedback.hideLoading(); }
        function showError(message, detail) { UIFeedback.showError(message, detail); }
        function hideError() { UIFeedback.hideError(); }
        function showSuccess(message) { UIFeedback.showSuccess(message); }
        function renderMarkdown(markdown, targetElement) { ContentRenderer.renderMarkdown(markdown, targetElement); }
        function setupDownloadButton(targetContentId, baseFilename, containerId) { 
            DownloadManager.setupDownloadButton(targetContentId, baseFilename, containerId); 
        }
        
        // Toggle Verbose mode (debug panel)
        const debugModeCheckbox = document.getElementById('debug-mode');
        if (debugModeCheckbox) {
            debugModeCheckbox.addEventListener('change', function() {
                document.getElementById('debug-panel').style.display = this.checked ? 'block' : 'none';
            });
        }
        
        // Show error details button
        const showErrorDetailsBtn = document.getElementById('show-error-details');
        if (showErrorDetailsBtn) {
            showErrorDetailsBtn.addEventListener('click', function() {
                const detailsContent = document.getElementById('error-details-content');
                detailsContent.style.display = detailsContent.style.display === 'none' ? 'block' : 'none';
            });
        }
        
        // Clear Session button in sidebar
        const clearSessionSidebarBtn = document.getElementById('clear-session-sidebar-btn');
        if (clearSessionSidebarBtn) {
            clearSessionSidebarBtn.addEventListener('click', async function() {
                if (confirm('Are you sure you want to clear all session data? This will reset the application state.')) {
                    // Clear client-side storage immediately.
                    sessionStorage.clear();
                    localStorage.clear();

                    try {
                        // Wait for the server to confirm the session is cleared.
                        const response = await fetch('/api/clear-session', { method: 'POST' });
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            throw new Error(errorData.error || 'Failed to clear server session.');
                        }
                        
                        // Now that server and client are clear, inform the user and redirect.
                        alert('Session cleared. The application will now restart.');
                        window.location.href = '/';

                    } catch (error) {
                        console.error('Error clearing session:', error);
                        alert('Could not fully clear the session. Please try again. Error: ' + error.message);
                    }
                }
            });
        }

        // Function to check prerequisites for Hunt Planning button and style it
        function checkHuntPlanningPrerequisites() {
            const huntPlanningBtn = document.getElementById('hunt-planning-btn');
            if (!huntPlanningBtn) {
                return;
            }

            const researchDone = sessionStorage.getItem('report_md')?.trim();
            const hypothesisDone = sessionStorage.getItem('refined_hypothesis')?.trim() || sessionStorage.getItem('current_hypothesis')?.trim();
            const ableDone = sessionStorage.getItem('able_table_md')?.trim();
            const discoveryDone = sessionStorage.getItem('data_sources_md')?.trim();

            const allPrerequisitesMet = researchDone && hypothesisDone && ableDone && discoveryDone;

            if (allPrerequisitesMet) {
                huntPlanningBtn.classList.remove('disabled'); 
                huntPlanningBtn.classList.remove('btn-hunt-planning-disabled-color');
                if (!huntPlanningBtn.classList.contains('btn-success')) {
                     huntPlanningBtn.classList.add('btn-success');
                }
            } else {
                huntPlanningBtn.classList.add('disabled'); 
                huntPlanningBtn.classList.add('btn-hunt-planning-disabled-color'); 
            }
        }

        // Call this function when the page loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', checkHuntPlanningPrerequisites);
        } else {
            checkHuntPlanningPrerequisites();
        }

        // Add page-specific JavaScript
        {% block script %}{% endblock %}
    </script>
</body>
</html>
