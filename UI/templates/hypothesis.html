{% extends "base.html" %}

{% set prev_phase_url = "/research" %}
{% set prev_phase_name = "Topic Research" %}
{% set next_phase_url = "/refinement" %}
{% set next_phase_name = "Hypothesis Refinement (Optional)" %}

{% block nav %}{{ super() }}{% endblock %}

{% block content %}
<div class="phase-container">
    <!-- Header -->
    <div class="phase-header d-flex justify-content-between align-items-center">
        <h1 class="phase-title mb-0">Hypothesis Generation</h1>
        <div class="d-flex gap-2">
            <div id="download-hypo-actions-container" class="me-2" style="display: none;"><!-- Download button will be inserted here by setupDownloadButton --></div>
            <button id="get-hypos-btn" class="btn btn-primary">
                <i class="bi bi-robot me-2"></i>Get Suggestions
            </button>
            <div class="upload-container">
                <input type="file" id="upload-hypo-file" class="d-none" accept=".md,.txt">
                <button type="button" id="upload-hypo-btn" class="btn btn-outline-secondary">
                    <i class="bi bi-upload me-1"></i>Upload
                </button>
            </div>
        </div>
    </div>

    <!-- Compact Phase Description -->
    <p class="phase-description">
        Generate or input a hypothesis based on your research findings. You can have the AI suggest hypotheses, upload an existing one, or create your own manually below.
    </p>

    <!-- Warning for Missing Research -->
    <div id="no-research-warning" class="prerequisite-warning" style="display: none;">
        <h5><i class="bi bi-exclamation-triangle-fill me-2"></i>Missing Research</h5>
        <p class="mb-0">No research report found. Please <a href="/research">generate a research report</a> first.</p>
    </div>

        <div id="current-hypo-saved-msg" class="alert alert-success py-1" style="display:none;">
            <i class="bi bi-check-circle me-2"></i>Hypothesis saved successfully!
        </div>
    
    <!-- Hidden element for hypothesis storage (needed by download function) -->
    <div id="current-hypo-container" style="display: none;">
        <textarea id="current-hypo-edit" style="display: none;"></textarea>
    </div>

    <!-- Manual Input Section (full width when active) -->
    <div id="hypo-manual-input-section" class="mb-3">
        <textarea id="hypo-input" class="form-control" rows="3" 
                  placeholder="Describe the threat hypothesis you want to test..."></textarea>


    </div>
    


    <!-- AI Generation Section (full width) -->
    <div id="hypo-select-container" class="mb-3" style="display: none;">
        <div id="hypo-select" class="hypothesis-options">
            <!-- Options will be dynamically inserted here -->
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
// Final, corrected script block. Cache-buster: 1626013041
document.addEventListener('DOMContentLoaded', function() {
    // --- Element Getters ---
    const getSuggestionsBtn = document.getElementById('get-hypos-btn');
    const hypoSelectContainer = document.getElementById('hypo-select-container');
    const hypoSelect = document.getElementById('hypo-select');
    const hypoInput = document.getElementById('hypo-input');
    const noResearchWarning = document.getElementById('no-research-warning');
    const uploadBtn = document.getElementById('upload-hypo-btn');
    const fileInput = document.getElementById('upload-hypo-file');

    // --- State Management & UI Updates ---
    function saveHypothesis(hypothesisText) {
        if (typeof hypothesisText !== 'string' || hypothesisText.trim() === '') return;
        console.log('Saving hypothesis:', hypothesisText);
        sessionStorage.setItem('hypothesis', hypothesisText);
        sessionStorage.removeItem('refined_hypothesis'); // Clear stale refined data
        fetch('/api/save-selected-hypothesis', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ hypothesis: hypothesisText })
        }).catch(error => console.error('Failed to save hypothesis to server:', error));
    }

    function loadInitialData() {
        const savedHypothesis = sessionStorage.getItem('hypothesis');
        if (savedHypothesis) {
            console.log('Loading saved hypothesis from sessionStorage.');
            hypoInput.value = savedHypothesis;
        } else {
            console.log('No hypothesis in sessionStorage, checking server.');
            fetch('/api/debug-info')
                .then(r => r.json())
                .then(data => {
                    const sessionHypo = data?.session_data?.hypothesis;
                    if (sessionHypo) {
                        console.log('Loaded hypothesis from server.');
                        hypoInput.value = sessionHypo;
                        sessionStorage.setItem('hypothesis', sessionHypo); // Prime sessionStorage
                    }
                })
                .catch(e => console.error('Failed to fetch initial data:', e));
        }

        fetch('/api/debug-info')
            .then(r => r.json())
            .then(data => {
                if (!data?.session_data?.report_md) {
                    if (noResearchWarning) noResearchWarning.style.display = 'block';
                }
            });
    }

    // --- Event Listeners ---
    if (getSuggestionsBtn) {
        getSuggestionsBtn.addEventListener('click', function() {
            if (hypoSelectContainer) hypoSelectContainer.style.display = 'block';
            if (hypoSelect) hypoSelect.innerHTML = ''; // Clear previous results

            UIFeedback.show('loading', 'Getting AI suggestions...');

            fetch('/api/hypothesize', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            })
            .then(response => {
                if (!response.ok) throw new Error(`Server error: ${response.statusText}`);
                return response.json();
            })
            .then(data => {
                UIFeedback.hideLoading();
                if (!hypoSelect) return;

                if (data.success && data.hypotheses && data.hypotheses.length > 0) {
                    data.hypotheses.forEach((hypo, idx) => {
                        if (typeof hypo !== 'string' || hypo.trim() === '') return;
                        const optionDiv = document.createElement('div');
                        optionDiv.className = 'hypothesis-option p-3 mb-2 border rounded';
                        optionDiv.dataset.value = hypo;
                        optionDiv.innerHTML = `<p class="mb-0">${hypo.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</p>`;
                        hypoSelect.appendChild(optionDiv);
                    });
                } else {
                    UIFeedback.show('error', data.error || 'No suggestions were generated.');
                }
            })
            .catch(error => {
                UIFeedback.hideLoading();
                UIFeedback.show('error', `Error: ${error.message}`);
            });
        });
    }

    if (hypoSelect) {
        hypoSelect.addEventListener('click', function(event) {
            const selectedOption = event.target.closest('.hypothesis-option');
            if (!selectedOption) return;
            document.querySelectorAll('.hypothesis-option').forEach(opt => opt.classList.remove('selected'));
            selectedOption.classList.add('selected');
            const hypothesisText = selectedOption.dataset.value;
            hypoInput.value = hypothesisText;
            saveHypothesis(hypothesisText);
        });
    }

    if (hypoInput) {
        hypoInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                saveHypothesis(this.value.trim());
                // Optionally, provide feedback that it was saved
                this.blur(); // Remove focus from the textarea
            }
        });

        hypoInput.addEventListener('blur', function() {
            saveHypothesis(this.value.trim());
        });
    }
    
    if(uploadBtn && fileInput){
        uploadBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const formData = new FormData();
            formData.append('file', file);
            if (typeof UIFeedback !== 'undefined') UIFeedback.show('loading', 'Uploading hypothesis...');
            fetch('/api/upload-hypothesis', { method: 'POST', body: formData })
                .then(r => r.json())
                .then(data => {
                    if (typeof UIFeedback !== 'undefined') UIFeedback.hideLoading();
                    if (data.success && data.hypothesis) {
                        hypoInput.value = data.hypothesis;
                        saveHypothesis(data.hypothesis);
                    } else {
                        if (typeof UIFeedback !== 'undefined') UIFeedback.show('error', data.error || 'Upload failed');
                    }
                })
                .catch(error => {
                    if (typeof UIFeedback !== 'undefined') UIFeedback.hideLoading();
                    if (typeof UIFeedback !== 'undefined') UIFeedback.show('error', 'Upload failed: ' + error.message);
                });
            event.target.value = '';
        });
    }

    // --- Manual Buttons (exposed to global scope for HTML onclick) ---



    // --- Initial Load ---
    loadInitialData();
});
{% endblock %}

{% block style %}
<style>

    .hypothesis-options {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        max-height: 400px;
        overflow-y: auto;
        background-color: #ffffff;
    }
    
    #hypo-select .hypothesis-option {
        padding: 1rem;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        cursor: pointer !important;
        transition: all 0.3s ease !important;
        line-height: 1.5;
        word-wrap: break-word;
        background-color: #ffffff !important;
        position: relative;
        margin-bottom: 0.75rem !important; /* Increased spacing */
        display: block;
    }
    
    #hypo-select .hypothesis-option:last-child {
        margin-bottom: 0;
    }
    
    .hypothesis-option:hover {
        background-color: #f8f9fa !important;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15) !important;
        transform: translateY(-2px) !important;
        border-left: 4px solid #0d6efd;
    }
    
    .hypothesis-option.selected {
        background-color: #0d6efd !important;
        color: white !important;
        box-shadow: 0 4px 12px rgba(13,110,253,0.3) !important;
        border-left: 4px solid #0b5ed7;
    }
    
    .hypothesis-option.selected:hover {
        background-color: #0b5ed7 !important;
        transform: translateY(-2px) !important;
    }
    
    /* Add a clickable indicator */
    .hypothesis-option::after {
        content: "Click to select";
        position: absolute;
        right: 16px;
        top: 50%;
        transform: translateY(-50%);
        opacity: 0;
        transition: opacity 0.3s ease;
        font-size: 12px;
        color: #6c757d;
        font-style: italic;
    }
    
    .hypothesis-option:hover::after {
        opacity: 1;
    }
    
    .hypothesis-option.selected::after {
        content: "âœ“ Selected";
        opacity: 1;
        color: white;
        font-weight: bold;
    }
</style>

<style>
    /* Force override for hypothesis option cards */
    #hypo-select .hypothesis-option {
        border: 1px solid #ced4da !important;
        border-radius: .375rem !important;
        margin-bottom: .75rem !important;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05) !important;
    }
</style>
{% endblock %}
